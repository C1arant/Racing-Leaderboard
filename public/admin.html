<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leaderboard Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body class="min-h-screen bg-black text-white">
  <div class="max-w-[1500px] mx-auto px-6 py-8">
    <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
      <div class="min-w-0">
        <p class="text-xs uppercase tracking-[0.35em] text-emerald-400">Racing Leaderboard</p>
        <h1 class="text-3xl md:text-4xl font-black tracking-tight">Lap Time Admin</h1>
        <p class="text-emerald-200/70">Add, edit, or remove lap times. Keep it simple and accurate.</p>
      </div>
      <nav class="flex items-center gap-2 text-sm">
        <a href="/" class="px-4 py-2 rounded-full border border-emerald-500/40 bg-emerald-500/10 hover:bg-emerald-500/20">Display</a>
        <a href="/fullscreen" class="px-4 py-2 rounded-full border border-emerald-500/40 bg-emerald-500/10 hover:bg-emerald-500/20">Fullscreen</a>
      </nav>
    </header>

    <div id="toast" class="hidden mb-6 rounded-2xl border border-emerald-500/40 bg-emerald-500/10 px-4 py-3 text-sm"></div>

    <div class="grid grid-cols-12 gap-6">
      <div class="col-span-12 lg:col-span-4 space-y-6">
        <section class="rounded-3xl border border-emerald-500/20 bg-gradient-to-br from-emerald-500/10 via-black to-black p-5 shadow-lg">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Security</h2>
            <span id="pinStatus" class="text-xs px-2 py-1 rounded-full border border-emerald-500/30 bg-black text-emerald-200/70">PIN: unknown</span>
          </div>

          <label class="text-xs text-emerald-200/70 mt-4 block">Admin PIN</label>
          <div class="mt-2 flex gap-2">
            <input id="pin" type="password" placeholder="Enter PIN"
              class="w-full bg-black border border-emerald-500/30 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/60" />
            <button id="savePin" class="px-4 py-2 rounded-xl bg-emerald-500 text-black font-semibold hover:bg-emerald-400">
              Save
            </button>
          </div>
        </section>

        <section class="rounded-3xl border border-emerald-500/20 bg-black/80 p-5 shadow-lg">
          <h2 class="text-lg font-semibold mb-3">Add Lap</h2>

          <form id="scoreForm" class="space-y-3">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs text-emerald-200/70">First</label>
                <input id="first" required class="mt-1 w-full bg-black border border-emerald-500/30 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/60" />
              </div>
              <div>
                <label class="text-xs text-emerald-200/70">Last</label>
                <input id="last" required class="mt-1 w-full bg-black border border-emerald-500/30 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/60" />
              </div>
            </div>

            <div>
              <label class="text-xs text-emerald-200/70">Lap time (m:ss.mmm)</label>
              <input id="time" required placeholder="1:23.456"
                class="mt-1 w-full bg-black border border-emerald-500/30 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/60" />
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs text-emerald-200/70">Game</label>
                <select id="game" class="mt-1 w-full bg-black border border-emerald-500/30 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/60">
                  <option>Assetto Corsa</option>
                  <option>F1 25</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-emerald-200/70">Day</label>
                <input id="day" class="mt-1 w-full bg-black border border-emerald-500/30 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/60" />
              </div>
            </div>

            <div>
              <label class="text-xs text-emerald-200/70">Track</label>
              <input id="track" required
                class="mt-1 w-full bg-black border border-emerald-500/30 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/60" />
            </div>

            <div>
              <label class="text-xs text-emerald-200/70">Car</label>
              <input id="car"
                class="mt-1 w-full bg-black border border-emerald-500/30 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/60" />
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs text-emerald-200/70">Cohort</label>
                <select id="cohort" class="mt-1 w-full bg-black border border-emerald-500/30 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/60">
                  <option>Guest</option>
                  <option>Staff</option>
                  <option>Y1</option>
                  <option>Y2</option>
                  <option>Y3</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-emerald-200/70">Course</label>
                <input id="course" placeholder="Games / Computing / Animation"
                  class="mt-1 w-full bg-black border border-emerald-500/30 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500/60" />
              </div>
            </div>

            <button class="w-full px-3 py-2 rounded-xl bg-emerald-500 text-black font-semibold hover:bg-emerald-400">
              Submit Lap
            </button>

            <p id="submitHint" class="text-xs text-emerald-200/60"></p>
          </form>
        </section>
      </div>

      <div class="col-span-12 lg:col-span-8">
        <section class="rounded-3xl border border-emerald-500/20 bg-black/80 p-5 shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Leaderboard Entries</h2>
            <span class="text-xs text-emerald-200/70" id="entryCount">0 entries</span>
          </div>

          <div id="entryList" class="space-y-2 max-h-[780px] overflow-auto pr-1"></div>
        </section>
      </div>
    </div>
  </div>

<script>
  const socket = io();

  const toast = document.getElementById("toast");
  function showToast(msg, ok=true) {
    toast.textContent = msg;
    toast.classList.remove("hidden");
    toast.className = "mb-6 rounded-2xl border bg-black px-4 py-3 text-sm " + (ok
      ? "border-emerald-500/40 text-emerald-200"
      : "border-white/30 text-white");
    setTimeout(() => toast.classList.add("hidden"), 3500);
  }

  // PIN
  const PIN_KEY = "leaderboard_admin_pin";
  const pinInput = document.getElementById("pin");
  const savePin = document.getElementById("savePin");
  const pinStatus = document.getElementById("pinStatus");
  pinInput.value = localStorage.getItem(PIN_KEY) || "";
  function getPin() { return (pinInput.value || "").trim(); }
  function pingPin() { socket.emit("adminPing", { pin: getPin() }); }

  savePin.addEventListener("click", () => {
    localStorage.setItem(PIN_KEY, getPin());
    pingPin();
    showToast("PIN saved to this browser.", true);
  });

  socket.on("adminPingResult", ({ ok }) => {
    pinStatus.textContent = ok ? "PIN: OK" : "PIN: WRONG";
    pinStatus.className = ok
      ? "text-xs px-2 py-1 rounded-full border border-emerald-500/40 bg-emerald-500/10 text-emerald-200"
      : "text-xs px-2 py-1 rounded-full border border-white/30 bg-black text-white";
  });

  // Data
  let scores = [];
  let ratings = {};

  const entryCount = document.getElementById("entryCount");
  const entryList = document.getElementById("entryList");

  const scoreForm = document.getElementById("scoreForm");
  const submitHint = document.getElementById("submitHint");

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function timeToMs(t) {
    const str = String(t).trim();
    if (/^\d+:\d{2}\.\d{3}$/.test(str)) {
      const [m, rest] = str.split(":");
      const [s, ms] = rest.split(".");
      return (parseInt(m,10) * 60 + parseInt(s,10)) * 1000 + parseInt(ms,10);
    }
    if (/^\d+\.\d{3}$/.test(str)) {
      const [s, ms] = str.split(".");
      return parseInt(s,10) * 1000 + parseInt(ms,10);
    }
    return Infinity;
  }

  function getRatingKey(game, first, last) {
    return `${String(game).trim()}|${String(first).trim().toLowerCase()}|${String(last).trim().toLowerCase()}`;
  }

  function ratingLabel(entry) {
    const key = getRatingKey(entry.game, entry.first, entry.last);
    const rating = ratings[key];
    if (!rating) return "—";
    const delta = rating.lastChange;
    const prefix = delta > 0 ? `+${delta}` : `${delta}`;
    return `${rating.rating} (${prefix})`;
  }

  function renderEntries() {
    const list = scores.slice().sort((a, b) => timeToMs(a.time) - timeToMs(b.time));

    entryCount.textContent = `${list.length} entries`;
    entryList.innerHTML = list.map((s, idx) => {
      return `
        <div class="flex items-center justify-between rounded-2xl border border-emerald-500/20 bg-black px-4 py-3">
          <div>
            <div class="text-sm text-emerald-200/70">#${idx + 1} • ${escapeHtml(s.game)} • ${escapeHtml(s.track)}</div>
            <div class="font-semibold text-white">${escapeHtml(`${s.first} ${s.last}`)}</div>
            <div class="text-xs text-emerald-200/60">${escapeHtml(s.time)} • ${escapeHtml(s.car || "—")} • iRating ${escapeHtml(ratingLabel(s))}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="text-xs text-emerald-200 hover:text-emerald-100" data-edit="${escapeHtml(s.id)}">Edit</button>
            <button class="text-xs text-white/80 hover:text-white" data-delete="${escapeHtml(s.id)}">Delete</button>
          </div>
        </div>
      `;
    }).join("");

    entryList.querySelectorAll("button[data-delete]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-delete");
        if (!confirm("Delete this leaderboard entry?")) return;
        socket.emit("adminDeleteScore", { pin: getPin(), id });
      });
    });

    entryList.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-edit");
        const entry = scores.find(row => row.id === id);
        if (!entry) return;
        const nextTime = prompt("Update lap time (m:ss.mmm)", entry.time || "");
        if (!nextTime) return;
        socket.emit("adminUpdateScore", { pin: getPin(), id, time: nextTime.trim() });
      });
    });
  }

  scoreForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const payload = {
      first: document.getElementById("first").value,
      last: document.getElementById("last").value,
      time: document.getElementById("time").value,
      day: document.getElementById("day").value,
      game: document.getElementById("game").value,
      car: document.getElementById("car").value,
      track: document.getElementById("track").value,
      cohort: document.getElementById("cohort").value,
      course: document.getElementById("course").value,
      eventId: "evt_default"
    };
    socket.emit("newScore", payload);
  });

  socket.on("submitResult", (res) => {
    if (res.ok) {
      submitHint.textContent = `Lap stored (${res.mode}). iRating ${res.ratingDelta >= 0 ? "+" : ""}${res.ratingDelta || 0}.`;
      scoreForm.reset();
    } else {
      submitHint.textContent = res.reason === "not_better" ? "Not faster than existing time." : "Invalid entry.";
    }
  });

  socket.on("adminResult", (res) => {
    if (!res.ok) {
      showToast("Admin action failed: " + (res.reason || "unknown"), false);
      return;
    }
    if (res.action === "updateScore") {
      showToast("Lap time updated.", true);
    } else if (res.action === "deleteScore") {
      showToast("Lap removed.", true);
    } else {
      showToast("Action completed.", true);
    }
  });

  socket.on("loadScores", (list) => {
    scores = Array.isArray(list) ? list : [];
    renderEntries();
  });

  socket.on("scoreUpdate", (row) => {
    scores.push(row);
    renderEntries();
  });

  socket.on("scoreReplace", (row) => {
    const idx = scores.findIndex(s => s.id === row.id);
    if (idx !== -1) scores[idx] = row; else scores.push(row);
    renderEntries();
  });

  socket.on("deleteScore", ({ id }) => {
    scores = scores.filter(s => s.id !== id);
    renderEntries();
  });

  socket.on("ratingsUpdate", (r) => {
    ratings = r || {};
    renderEntries();
  });

  pingPin();
</script>
</body>
</html>
