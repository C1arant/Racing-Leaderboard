<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leaderboard Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body class="min-h-screen bg-black text-white">
  <div class="max-w-[1500px] mx-auto px-6 py-8">
    <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
      <div class="min-w-0">
        <p class="text-xs uppercase tracking-[0.35em] text-red-500">Racing Leaderboard</p>
        <h1 class="text-3xl md:text-4xl font-black tracking-tight">Lap Time Admin</h1>
        <p class="text-white/60">Add, edit, or remove lap times. Keep it simple and accurate.</p>
      </div>
      <nav class="flex items-center gap-2 text-sm">
        <a href="/" class="px-4 py-2 rounded-md border border-white/20 bg-red-500/10 hover:bg-red-500/15">Display</a>
        <a href="/fullscreen" class="px-4 py-2 rounded-md border border-white/20 bg-red-500/10 hover:bg-red-500/15">Fullscreen</a>
      </nav>
    </header>

    <div id="toast" class="hidden mb-6 rounded-lg border border-white/20 bg-red-500/10 px-4 py-3 text-sm"></div>

    <div class="grid grid-cols-12 gap-6">
      <div class="col-span-12 lg:col-span-4 space-y-6">
        <section class="rounded-md border border-white/10 bg-gradient-to-br from-red-500/10 via-black to-black p-5 shadow-lg">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Security</h2>
            <span id="pinStatus" class="text-xs px-2 py-1 rounded-md border border-white/15 bg-black text-white/60">PIN: unknown</span>
          </div>

          <label class="text-xs text-white/60 mt-4 block">Admin PIN</label>
          <div class="mt-2 flex gap-2">
            <input id="pin" type="password" placeholder="Enter PIN"
              class="w-full bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" />
            <button id="savePin" class="px-4 py-2 rounded-md bg-red-500 text-black font-semibold hover:bg-red-400">
              Save
            </button>
          </div>
        </section>

        <section class="rounded-md border border-white/10 bg-black/90 p-5 shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <h2 id="formTitle" class="text-lg font-semibold">Add Lap</h2>
            <span id="editBadge" class="hidden text-xs rounded-md border border-white/20 bg-red-500/10 px-2 py-1 text-white">Editing</span>
          </div>

          <form id="scoreForm" class="space-y-3">
            <div id="editBanner" class="hidden rounded-lg border border-white/15 bg-red-500/10 px-3 py-2 text-xs text-white">
              Editing <span id="editName" class="font-semibold"></span>
              <button id="cancelEdit" type="button" class="ml-2 underline underline-offset-2 hover:text-white">Cancel</button>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs text-white/60">First</label>
                <input id="first" required class="mt-1 w-full bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" />
              </div>
              <div>
                <label class="text-xs text-white/60">Last</label>
                <input id="last" required class="mt-1 w-full bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" />
              </div>
            </div>

            <div>
              <label class="text-xs text-white/60">Lap time (m:ss.mmm)</label>
              <input id="time" required placeholder="1:23.456"
                class="mt-1 w-full bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" />
            </div>

            <input id="game" type="hidden" value="Assetto Corsa" />

            <div>
              <label class="text-xs text-white/60">Day</label>
              <div class="mt-1 flex gap-2">
                <input id="day" class="w-full bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" />
                <button id="setToday" type="button" class="px-3 py-2 rounded-md border border-white/20 text-white hover:bg-red-500/10">Today</button>
              </div>
            </div>

            <div>
              <label class="text-xs text-white/60">Track</label>
              <div class="mt-1 flex gap-2">
                <input id="track" required
                  class="flex-1 bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" />
                <button id="useDefaultTrack" type="button" class="px-3 py-2 rounded-md border border-white/20 text-white hover:bg-red-500/10">
                  Use default
                </button>
              </div>
            </div>

            <div>
              <label class="text-xs text-white/60">Car</label>
              <input id="car"
                class="mt-1 w-full bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" />
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs text-white/60">Cohort</label>
                <select id="cohort" class="mt-1 w-full bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50">
                  <option>Guest</option>
                  <option>Staff</option>
                  <option>Y1</option>
                  <option>Y2</option>
                  <option>Y3</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-white/60">Course</label>
                <input id="course" placeholder="Games / Computing / Animation"
                  class="mt-1 w-full bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" />
              </div>
            </div>

            <button id="submitButton" class="w-full px-3 py-2 rounded-md bg-red-500 text-black font-semibold hover:bg-red-400">
              Submit Lap
            </button>

            <p id="submitHint" class="text-xs text-white/50"></p>
          </form>
        </section>
      </div>

      <div class="col-span-12 lg:col-span-8">
        <section class="rounded-md border border-white/10 bg-black/90 p-5 shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Leaderboard Entries</h2>
            <span class="text-xs text-white/60" id="entryCount">0 entries</span>
          </div>

          <div id="entryList" class="space-y-2 max-h-[780px] overflow-auto pr-1"></div>
        </section>
      </div>
    </div>

    <div class="grid grid-cols-12 gap-6 mt-6">
      <div class="col-span-12 lg:col-span-4 space-y-6">
        <section class="rounded-md border border-white/10 bg-black/90 p-5 shadow-lg">
          <h2 class="text-lg font-semibold mb-3">Track Settings</h2>
          <label class="text-xs text-white/60">Default track (display + telemetry)</label>
          <div class="mt-2 flex gap-2">
            <select id="defaultTrackSelect" class="flex-1 bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50">
              <option value="spa">Loading tracks…</option>
            </select>
            <button id="saveTrack" class="px-4 py-2 rounded-md bg-red-500 text-black font-semibold hover:bg-red-400">
              Set
            </button>
          </div>
          <p class="text-xs text-white/50 mt-2">Used by display, fullscreen, map, and pit wall screens.</p>
        </section>

        <section class="rounded-md border border-white/10 bg-black/90 p-5 shadow-lg">
          <h2 class="text-lg font-semibold mb-3">Bulk Add</h2>
          <p class="text-xs text-white/60">Paste CSV lines: first,last,time,day,car,track,cohort,course</p>
          <textarea id="bulkInput" rows="6" class="mt-2 w-full bg-black border border-white/15 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" placeholder="Jane,Doe,2:18.442,Mon,BMW M4,Spa,Staff,Games"></textarea>
          <div class="mt-3 flex gap-2">
            <button id="bulkSubmit" class="px-4 py-2 rounded-md bg-red-500 text-black font-semibold hover:bg-red-400">Add laps</button>
            <button id="bulkClear" class="px-4 py-2 rounded-md border border-white/20 text-white hover:bg-red-500/10">Clear</button>
          </div>
        </section>
      </div>
    </div>
  </div>

<script>
  const socket = io();

  const toast = document.getElementById("toast");
  function showToast(msg, ok=true) {
    toast.textContent = msg;
    toast.classList.remove("hidden");
    toast.className = "mb-6 rounded-lg border bg-black px-4 py-3 text-sm " + (ok
      ? "border-white/20 text-white/80"
      : "border-white/30 text-white");
    setTimeout(() => toast.classList.add("hidden"), 3500);
  }

  // PIN
  const PIN_KEY = "leaderboard_admin_pin";
  const pinInput = document.getElementById("pin");
  const savePin = document.getElementById("savePin");
  const pinStatus = document.getElementById("pinStatus");
  pinInput.value = localStorage.getItem(PIN_KEY) || "";
  function getPin() { return (pinInput.value || "").trim(); }
  function pingPin() { socket.emit("adminPing", { pin: getPin() }); }

  savePin.addEventListener("click", () => {
    localStorage.setItem(PIN_KEY, getPin());
    pingPin();
    showToast("PIN saved to this browser.", true);
  });

  socket.on("adminPingResult", ({ ok }) => {
    pinStatus.textContent = ok ? "PIN: OK" : "PIN: WRONG";
    pinStatus.className = ok
      ? "text-xs px-2 py-1 rounded-md border border-white/20 bg-red-500/10 text-white/80"
      : "text-xs px-2 py-1 rounded-md border border-white/30 bg-black text-white";
  });

  // Data
  let scores = [];
  let ratings = {};

  const entryCount = document.getElementById("entryCount");
  const entryList = document.getElementById("entryList");

  const scoreForm = document.getElementById("scoreForm");
  const submitHint = document.getElementById("submitHint");
  const setToday = document.getElementById("setToday");
  const dayInput = document.getElementById("day");
  const formTitle = document.getElementById("formTitle");
  const submitButton = document.getElementById("submitButton");
  const editBadge = document.getElementById("editBadge");
  const editBanner = document.getElementById("editBanner");
  const editName = document.getElementById("editName");
  const cancelEdit = document.getElementById("cancelEdit");
  const useDefaultTrack = document.getElementById("useDefaultTrack");
  const defaultTrackSelect = document.getElementById("defaultTrackSelect");
  const saveTrack = document.getElementById("saveTrack");
  const bulkInput = document.getElementById("bulkInput");
  const bulkSubmit = document.getElementById("bulkSubmit");
  const bulkClear = document.getElementById("bulkClear");

  let editId = null;
  let defaultTrack = "spa";

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function timeToMs(t) {
    const str = String(t).trim();
    if (/^\d+:\d{2}\.\d{3}$/.test(str)) {
      const [m, rest] = str.split(":");
      const [s, ms] = rest.split(".");
      return (parseInt(m,10) * 60 + parseInt(s,10)) * 1000 + parseInt(ms,10);
    }
    if (/^\d+\.\d{3}$/.test(str)) {
      const [s, ms] = str.split(".");
      return parseInt(s,10) * 1000 + parseInt(ms,10);
    }
    return Infinity;
  }

  function getRatingKey(game, first, last) {
    return `${String(game).trim()}|${String(first).trim().toLowerCase()}|${String(last).trim().toLowerCase()}`;
  }

  function ratingLabel(entry) {
    const key = getRatingKey(entry.game, entry.first, entry.last);
    const rating = ratings[key];
    if (!rating) return "—";
    const delta = rating.lastChange;
    const prefix = delta > 0 ? `+${delta}` : `${delta}`;
    return `${rating.rating} (${prefix})`;
  }

  function renderEntries() {
    const list = scores.slice().sort((a, b) => timeToMs(a.time) - timeToMs(b.time));

    entryCount.textContent = `${list.length} entries`;
    entryList.innerHTML = list.map((s, idx) => {
      return `
        <div class="flex items-center justify-between rounded-lg border border-white/10 bg-black px-4 py-3">
          <div>
            <div class="text-sm text-white/60">#${idx + 1} • ${escapeHtml(s.track)}</div>
            <div class="font-semibold text-white">${escapeHtml(`${s.first} ${s.last}`)}</div>
            <div class="text-xs text-white/50">${escapeHtml(s.time)} • ${escapeHtml(s.car || "—")} • DR ${escapeHtml(ratingLabel(s))}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="text-xs text-white/80 hover:text-white" data-edit="${escapeHtml(s.id)}">Edit</button>
            <button class="text-xs text-white/80 hover:text-white" data-delete="${escapeHtml(s.id)}">Delete</button>
          </div>
        </div>
      `;
    }).join("");

    entryList.querySelectorAll("button[data-delete]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-delete");
        if (!confirm("Delete this leaderboard entry?")) return;
        socket.emit("adminDeleteScore", { pin: getPin(), id });
      });
    });

    entryList.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-edit");
        const entry = scores.find(row => row.id === id);
        if (!entry) return;
        editId = id;
        formTitle.textContent = "Edit Lap";
        submitButton.textContent = "Save Changes";
        editBadge.classList.remove("hidden");
        editBanner.classList.remove("hidden");
        editName.textContent = `${entry.first} ${entry.last}`.trim();

        document.getElementById("first").value = entry.first || "";
        document.getElementById("last").value = entry.last || "";
        document.getElementById("time").value = entry.time || "";
        document.getElementById("day").value = entry.day || "";
        document.getElementById("car").value = entry.car || "";
        document.getElementById("track").value = entry.track || "";
        document.getElementById("cohort").value = entry.cohort || "Guest";
        document.getElementById("course").value = entry.course || "";
      });
    });
  }

  function clearEdit() {
    editId = null;
    formTitle.textContent = "Add Lap";
    submitButton.textContent = "Submit Lap";
    editBadge.classList.add("hidden");
    editBanner.classList.add("hidden");
    editName.textContent = "";
  }

  cancelEdit.addEventListener("click", () => {
    clearEdit();
    scoreForm.reset();
    document.getElementById("game").value = "Assetto Corsa";
  });

  function setDayToday() {
    dayInput.value = new Date().toLocaleDateString("en-GB", { weekday: "short" });
  }

  setToday.addEventListener("click", setDayToday);

  scoreForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const payload = {
      first: document.getElementById("first").value,
      last: document.getElementById("last").value,
      time: document.getElementById("time").value,
      day: document.getElementById("day").value,
      game: document.getElementById("game").value,
      car: document.getElementById("car").value,
      track: document.getElementById("track").value,
      cohort: document.getElementById("cohort").value,
      course: document.getElementById("course").value
    };
    if (editId) {
      socket.emit("adminUpdateScore", { pin: getPin(), id: editId, ...payload });
    } else {
      socket.emit("newScore", payload);
    }
  });

  socket.on("submitResult", (res) => {
    if (res.ok) {
      submitHint.textContent = `Lap stored (${res.mode}). DR ${res.ratingDelta >= 0 ? "+" : ""}${res.ratingDelta || 0}.`;
      document.getElementById("time").value = "";
      document.getElementById("car").value = "";
      document.getElementById("track").value = "";
      document.getElementById("day").value = "";
    } else {
      submitHint.textContent = res.reason === "not_better" ? "Not faster than existing time." : "Invalid entry.";
    }
  });

  socket.on("adminResult", (res) => {
    if (!res.ok) {
      showToast("Admin action failed: " + (res.reason || "unknown"), false);
      return;
    }
    if (res.action === "updateScore") {
      showToast("Lap time updated.", true);
      clearEdit();
      scoreForm.reset();
      document.getElementById("game").value = "Assetto Corsa";
    } else if (res.action === "setTrack") {
      showToast("Default track updated.", true);
    } else if (res.action === "deleteScore") {
      showToast("Lap removed.", true);
    } else {
      showToast("Action completed.", true);
    }
  });

  socket.on("loadScores", (list) => {
    scores = Array.isArray(list) ? list : [];
    renderEntries();
  });

  socket.on("scoreUpdate", (row) => {
    scores.push(row);
    renderEntries();
  });

  socket.on("scoreReplace", (row) => {
    const idx = scores.findIndex(s => s.id === row.id);
    if (idx !== -1) scores[idx] = row; else scores.push(row);
    renderEntries();
  });

  socket.on("deleteScore", ({ id }) => {
    scores = scores.filter(s => s.id !== id);
    renderEntries();
  });

  socket.on("ratingsUpdate", (r) => {
    ratings = r || {};
    renderEntries();
  });

  function fillDefaultTrack(trackId) {
    defaultTrack = trackId || defaultTrack;
    if (defaultTrackSelect) defaultTrackSelect.value = defaultTrack;
  }

  async function loadTracks() {
    try {
      const res = await fetch("/api/tracks");
      const tracks = await res.json();
      defaultTrackSelect.innerHTML = tracks.map(t => `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`).join("");
      fillDefaultTrack(defaultTrack);
    } catch {
      defaultTrackSelect.innerHTML = `<option value="spa">spa</option>`;
    }
  }

  useDefaultTrack.addEventListener("click", () => {
    document.getElementById("track").value = defaultTrack;
  });

  saveTrack.addEventListener("click", () => {
    socket.emit("adminSetTrack", { pin: getPin(), trackId: defaultTrackSelect.value });
  });

  bulkClear.addEventListener("click", () => {
    bulkInput.value = "";
  });

  bulkSubmit.addEventListener("click", () => {
    const lines = bulkInput.value.split("\n").map(l => l.trim()).filter(Boolean);
    if (!lines.length) {
      showToast("No bulk entries found.", false);
      return;
    }
    const base = {
      day: document.getElementById("day").value,
      game: "Assetto Corsa",
      car: document.getElementById("car").value,
      track: document.getElementById("track").value || defaultTrack,
      cohort: document.getElementById("cohort").value,
      course: document.getElementById("course").value
    };
    let sent = 0;
    for (const line of lines) {
      const parts = line.split(",").map(p => p.trim());
      const [first, last, time, day, car, track, cohort, course] = parts;
      if (!first || !last || !time) continue;
      const payload = {
        first,
        last,
        time,
        day: day || base.day,
        game: base.game,
        car: car || base.car,
        track: track || base.track,
        cohort: cohort || base.cohort,
        course: course || base.course
      };
      socket.emit("newScore", payload);
      sent += 1;
    }
    showToast(`Submitted ${sent} bulk entries.`, true);
  });

  socket.on("settingsUpdate", (s) => {
    defaultTrack = s?.defaultTrack || defaultTrack;
    fillDefaultTrack(defaultTrack);
  });

  setDayToday();
  pingPin();
  loadTracks();
</script>
</body>
</html>
