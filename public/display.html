<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leaderboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root{
      --t-title: clamp(22px, 2.2vw, 44px);
      --t-sub: clamp(12px, 1.0vw, 16px);
      --t-base: clamp(13px, 1.05vw, 18px);
      --t-time: clamp(16px, 1.6vw, 26px);
    }
    .t-title{ font-size: var(--t-title); }
    .t-sub{ font-size: var(--t-sub); }
    .t-base{ font-size: var(--t-base); }
    .t-time{ font-size: var(--t-time); }

    .pulse-new { animation: pulseNew 1.1s ease-out 1; }
    @keyframes pulseNew {
      0%   { box-shadow: 0 0 0 0 rgba(16,185,129,0.30); background-color: rgba(16,185,129,0.06); }
      60%  { box-shadow: 0 0 0 22px rgba(16,185,129,0.00); }
      100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.00); background-color: transparent; }
    }
  </style>
</head>

<body class="min-h-screen bg-zinc-950 text-zinc-100">
  <div class="max-w-[1700px] mx-auto px-6 py-6">
    <div class="flex items-end justify-between gap-4 mb-5">
      <div class="min-w-0">
        <div class="flex items-center gap-3 min-w-0">
          <h1 class="t-title font-extrabold tracking-tight truncate">üèÅ Leaderboards</h1>
          <span id="liveEventBadge" class="t-sub inline-flex items-center gap-2 bg-zinc-900/60 border border-zinc-800 rounded-full px-3 py-2 text-zinc-200">
            LIVE: <span id="liveEventName" class="font-semibold">‚Äî</span>
          </span>
        </div>
        <p class="t-sub text-zinc-400 mt-1">Search names, tracks, cars ‚Ä¢ All events available</p>
      </div>
      <div class="flex items-center gap-2 t-sub">
        <a href="/fullscreen" class="hidden md:inline-block underline text-zinc-300 hover:text-white">Fullscreen</a>
        <a href="/admin" class="underline text-zinc-300 hover:text-white">Admin</a>
      </div>
    </div>

    <!-- Mode toggle -->
    <div class="flex flex-wrap items-center gap-2 mb-4">
      <button id="tabLeaderboard" class="t-base px-4 py-2 rounded-xl bg-white text-black font-semibold">Leaderboard</button>
      <button id="tabAttempts" class="t-base px-4 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition">All Laps (History)</button>

      <div class="ml-auto flex flex-wrap items-center gap-2">
        <input id="q" placeholder="Search name / track / car / course‚Ä¶"
               class="t-base w-[520px] max-w-full bg-zinc-900/60 border border-zinc-800 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-600" />
        <button id="clearQ" class="t-base px-3 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition">Clear</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap-2 mb-4">
      <select id="eventSel" class="t-base bg-zinc-900/60 border border-zinc-800 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-600">
        <option value="">All Events</option>
      </select>

      <button class="game t-base px-4 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition" data-game="">
        Mixed
      </button>
      <button class="game t-base px-4 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition" data-game="Assetto Corsa">
        Assetto Corsa
      </button>
      <button class="game t-base px-4 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition" data-game="F1 25">
        F1 25
      </button>

      <input id="trackFilter" placeholder="Track filter (optional)"
             class="t-base w-72 max-w-full bg-zinc-900/60 border border-zinc-800 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-600" />
      <button id="clearTrack" class="t-base px-3 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition">Clear track</button>

      <span class="ml-auto t-sub text-zinc-400">
        Mode: <span id="bestModeLabel" class="font-semibold text-zinc-200">Best per driver</span>
      </span>
    </div>

    <!-- Leaderboard view -->
    <div id="leaderboardView" class="grid grid-cols-12 gap-4">
      <div class="col-span-12 xl:col-span-4 space-y-4">
        <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 shadow">
          <div class="flex items-center justify-between mb-3">
            <h2 class="t-base font-semibold">Podium</h2>
            <span class="t-sub text-zinc-400">Filtered view</span>
          </div>

          <div class="grid grid-cols-1 gap-3">
            <div class="rounded-2xl border border-amber-500/35 bg-gradient-to-r from-amber-500/18 to-zinc-950/0 p-4">
              <div class="flex items-center justify-between">
                <div class="t-base font-semibold">ü•á P1</div>
                <div class="t-sub text-zinc-300" id="p1_meta">‚Äî</div>
              </div>
              <div class="mt-2">
                <div class="t-base font-semibold" id="p1_driver">‚Äî</div>
                <div class="t-time font-extrabold tracking-tight" id="p1_time">‚Äî</div>
                <div class="t-sub text-zinc-300 mt-1" id="p1_detail">‚Äî</div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div class="rounded-2xl border border-zinc-200/25 bg-gradient-to-r from-zinc-200/10 to-zinc-950/0 p-4">
                <div class="flex items-center justify-between">
                  <div class="t-base font-semibold">ü•à P2</div>
                  <div class="t-sub text-zinc-300" id="p2_meta">‚Äî</div>
                </div>
                <div class="mt-2">
                  <div class="t-base font-semibold" id="p2_driver">‚Äî</div>
                  <div class="t-time font-extrabold tracking-tight" id="p2_time">‚Äî</div>
                  <div class="t-sub text-zinc-300 mt-1" id="p2_detail">‚Äî</div>
                </div>
              </div>

              <div class="rounded-2xl border border-orange-300/25 bg-gradient-to-r from-orange-500/12 to-zinc-950/0 p-4">
                <div class="flex items-center justify-between">
                  <div class="t-base font-semibold">ü•â P3</div>
                  <div class="t-sub text-zinc-300" id="p3_meta">‚Äî</div>
                </div>
                <div class="mt-2">
                  <div class="t-base font-semibold" id="p3_driver">‚Äî</div>
                  <div class="t-time font-extrabold tracking-tight" id="p3_time">‚Äî</div>
                  <div class="t-sub text-zinc-300 mt-1" id="p3_detail">‚Äî</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 shadow">
          <h2 class="t-base font-semibold mb-2">Tip</h2>
          <p class="t-sub text-zinc-400">
            Use <span class="text-zinc-200 font-semibold">All Laps</span> to see every attempt for a driver, across all events.
          </p>
        </div>
      </div>

      <div class="col-span-12 xl:col-span-8">
        <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden shadow">
          <div class="overflow-x-auto">
            <table class="w-full t-base">
              <thead class="bg-zinc-950/60 text-zinc-300">
                <tr>
                  <th class="text-left px-5 py-4 w-16">#</th>
                  <th class="text-left px-5 py-4">Driver</th>
                  <th class="text-left px-5 py-4 w-36">Time</th>
                  <th class="text-left px-5 py-4 w-36">Game</th>
                  <th class="text-left px-5 py-4">Track</th>
                  <th class="text-left px-5 py-4">Car</th>
                  <th class="text-left px-5 py-4 w-64">Event</th>
                </tr>
              </thead>
              <tbody id="lbRows" class="divide-y divide-zinc-800"></tbody>
            </table>
          </div>
          <div class="px-5 py-3 bg-zinc-950/40 t-base text-zinc-400 flex justify-between">
            <span id="lbCount">0 entries</span>
            <span>Fastest first</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Attempts view -->
    <div id="attemptsView" class="hidden">
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden shadow">
        <div class="overflow-x-auto">
          <table class="w-full t-base">
            <thead class="bg-zinc-950/60 text-zinc-300">
              <tr>
                <th class="text-left px-5 py-4 w-40">When</th>
                <th class="text-left px-5 py-4">Driver</th>
                <th class="text-left px-5 py-4 w-36">Time</th>
                <th class="text-left px-5 py-4 w-36">Game</th>
                <th class="text-left px-5 py-4">Track</th>
                <th class="text-left px-5 py-4">Car</th>
                <th class="text-left px-5 py-4 w-64">Event</th>
              </tr>
            </thead>
            <tbody id="attRows" class="divide-y divide-zinc-800"></tbody>
          </table>
        </div>
        <div class="px-5 py-3 bg-zinc-950/40 t-base text-zinc-400 flex justify-between">
          <span id="attCount">0 laps</span>
          <span>Newest first</span>
        </div>
      </div>
    </div>
  </div>

<script>
  const socket = io();

  // Tabs
  const tabLeaderboard = document.getElementById("tabLeaderboard");
  const tabAttempts = document.getElementById("tabAttempts");
  const leaderboardView = document.getElementById("leaderboardView");
  const attemptsView = document.getElementById("attemptsView");

  // Inputs
  const q = document.getElementById("q");
  const clearQ = document.getElementById("clearQ");
  const eventSel = document.getElementById("eventSel");
  const trackFilter = document.getElementById("trackFilter");
  const clearTrack = document.getElementById("clearTrack");
  const gameButtons = Array.from(document.querySelectorAll(".game"));

  // UI
  const liveEventName = document.getElementById("liveEventName");
  const bestModeLabel = document.getElementById("bestModeLabel");

  // Leaderboard table
  const lbRows = document.getElementById("lbRows");
  const lbCount = document.getElementById("lbCount");

  // Podium
  const P = {
    p1_driver: document.getElementById("p1_driver"),
    p1_time: document.getElementById("p1_time"),
    p1_detail: document.getElementById("p1_detail"),
    p1_meta: document.getElementById("p1_meta"),
    p2_driver: document.getElementById("p2_driver"),
    p2_time: document.getElementById("p2_time"),
    p2_detail: document.getElementById("p2_detail"),
    p2_meta: document.getElementById("p2_meta"),
    p3_driver: document.getElementById("p3_driver"),
    p3_time: document.getElementById("p3_time"),
    p3_detail: document.getElementById("p3_detail"),
    p3_meta: document.getElementById("p3_meta"),
  };

  // Attempts table
  const attRows = document.getElementById("attRows");
  const attCount = document.getElementById("attCount");

  // Data
  let scores = [];
  let attempts = [];
  let settings = { events: [], bestPerDriver: true, fullscreen: { eventId: "", game: "" } };

  let activeGame = ""; // "" = Mixed
  let activeView = "leaderboard"; // or "attempts"

  const pulseIds = new Map(); // row id -> expiry

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function timeToMs(t) {
    const str = String(t).trim();
    if (/^\d+:\d{2}\.\d{3}$/.test(str)) {
      const [m, rest] = str.split(":");
      const [s, ms] = rest.split(".");
      return (parseInt(m,10) * 60 + parseInt(s,10)) * 1000 + parseInt(ms,10);
    }
    if (/^\d+\.\d{3}$/.test(str)) {
      const [s, ms] = str.split(".");
      return parseInt(s,10) * 1000 + parseInt(ms,10);
    }
    return Infinity;
  }

  function setActiveGame(game) {
    activeGame = game;
    gameButtons.forEach(b => {
      const on = b.dataset.game === activeGame;
      b.classList.toggle("bg-white", on);
      b.classList.toggle("text-black", on);
      b.classList.toggle("font-semibold", on);
    });
    render();
  }

  function setView(view) {
    activeView = view;
    const lbOn = view === "leaderboard";
    leaderboardView.classList.toggle("hidden", !lbOn);
    attemptsView.classList.toggle("hidden", lbOn);

    tabLeaderboard.className = lbOn
      ? "t-base px-4 py-2 rounded-xl bg-white text-black font-semibold"
      : "t-base px-4 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition";

    tabAttempts.className = !lbOn
      ? "t-base px-4 py-2 rounded-xl bg-white text-black font-semibold"
      : "t-base px-4 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition";

    render();
  }

  tabLeaderboard.addEventListener("click", () => setView("leaderboard"));
  tabAttempts.addEventListener("click", () => setView("attempts"));

  clearQ.addEventListener("click", () => { q.value = ""; render(); });
  clearTrack.addEventListener("click", () => { trackFilter.value = ""; render(); });
  q.addEventListener("input", () => render());
  eventSel.addEventListener("change", () => render());
  trackFilter.addEventListener("input", () => render());
  gameButtons.forEach(b => b.addEventListener("click", () => setActiveGame(b.dataset.game)));

  function cleanupPulse() {
    const now = Date.now();
    for (const [id, exp] of pulseIds.entries()) if (exp <= now) pulseIds.delete(id);
  }

  function currentEventName(eventId) {
    const evt = settings.events?.find(e => e.id === eventId);
    return evt?.name || "Event";
  }

  function passesFiltersCommon(item) {
    const qq = q.value.trim().toLowerCase();
    const ev = eventSel.value; // "" = all events
    const tf = trackFilter.value.trim().toLowerCase();

    if (activeGame && item.game !== activeGame) return false;
    if (ev && item.eventId !== ev) return false;
    if (tf && !String(item.track || "").toLowerCase().includes(tf)) return false;

    if (qq) {
      const hay = `${item.first} ${item.last} ${item.track} ${item.car} ${item.game} ${item.course} ${item.cohort} ${item.eventName}`.toLowerCase();
      if (!hay.includes(qq)) return false;
    }
    return true;
  }

  function setPodium(rank, s) {
    const id = rank === 1 ? "p1" : rank === 2 ? "p2" : "p3";
    if (!s) {
      P[`${id}_driver`].textContent = "‚Äî";
      P[`${id}_time`].textContent = "‚Äî";
      P[`${id}_detail`].textContent = "‚Äî";
      P[`${id}_meta`].textContent = "‚Äî";
      return;
    }
    P[`${id}_driver`].textContent = `${s.first} ${s.last}`.trim();
    P[`${id}_time`].textContent = s.time || "‚Äî";
    P[`${id}_detail`].textContent = `${s.game} ‚Ä¢ ${s.track} ‚Ä¢ ${s.car || "‚Äî"}`;
    P[`${id}_meta`].textContent = `${s.cohort || "Guest"} ‚Ä¢ ${s.course || "‚Äî"}`;
  }

  function renderLeaderboard() {
    cleanupPulse();

    let list = scores.filter(passesFiltersCommon);

    // Display best mode is a setting (but scores already store best-of).
    // Still show label so people know what they're looking at.
    bestModeLabel.textContent = settings.bestPerDriver ? "Best per driver" : "Best per driver (server-enforced)";

    list.sort((a,b) => timeToMs(a.time) - timeToMs(b.time));

    setPodium(1, list[0]);
    setPodium(2, list[1]);
    setPodium(3, list[2]);

    const view = list.slice(0, 30);

    lbRows.innerHTML = view.map((s, i) => {
      const rank = i + 1;
      const pulse = pulseIds.has(s.id) ? "pulse-new" : "";
      return `
        <tr class="${pulse} hover:bg-zinc-950/30">
          <td class="px-5 py-4 text-zinc-300 font-semibold">${rank}</td>
          <td class="px-5 py-4 text-white font-medium">${escapeHtml(s.first)} ${escapeHtml(s.last)}</td>
          <td class="px-5 py-4 text-white font-extrabold t-time tracking-tight">${escapeHtml(s.time)}</td>
          <td class="px-5 py-4 text-zinc-200">${escapeHtml(s.game)}</td>
          <td class="px-5 py-4 text-zinc-100">${escapeHtml(s.track)}</td>
          <td class="px-5 py-4 text-zinc-300">${escapeHtml(s.car || "‚Äî")}</td>
          <td class="px-5 py-4 text-zinc-300">${escapeHtml(s.eventName || currentEventName(s.eventId))}</td>
        </tr>
      `;
    }).join("");

    lbCount.textContent = `${list.length} entries (showing ${view.length})`;
  }

  function renderAttempts() {
    let list = attempts.filter(passesFiltersCommon);
    list.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

    const view = list.slice(0, 250);

    attRows.innerHTML = view.map((a) => {
      const when = new Date(a.createdAt).toLocaleString("en-GB", { year:"2-digit", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      return `
        <tr class="hover:bg-zinc-950/30">
          <td class="px-5 py-4 text-zinc-300">${escapeHtml(when)}</td>
          <td class="px-5 py-4 text-white font-medium">${escapeHtml(a.first)} ${escapeHtml(a.last)}</td>
          <td class="px-5 py-4 text-white font-extrabold t-time tracking-tight">${escapeHtml(a.time)}</td>
          <td class="px-5 py-4 text-zinc-200">${escapeHtml(a.game)}</td>
          <td class="px-5 py-4 text-zinc-100">${escapeHtml(a.track)}</td>
          <td class="px-5 py-4 text-zinc-300">${escapeHtml(a.car || "‚Äî")}</td>
          <td class="px-5 py-4 text-zinc-300">${escapeHtml(a.eventName || currentEventName(a.eventId))}</td>
        </tr>
      `;
    }).join("");

    attCount.textContent = `${list.length} laps (showing ${view.length})`;
  }

  function render() {
    if (activeView === "leaderboard") renderLeaderboard();
    else renderAttempts();
  }

  async function fetchAttemptsInitial() {
    // all events by default
    const res = await fetch("/api/attempts?limit=1500");
    attempts = await res.json();
    render();
  }

  // Socket events
  socket.on("loadScores", (existing) => {
    scores = Array.isArray(existing) ? existing : [];
    render();
  });

  socket.on("settingsUpdate", (s) => {
    settings = s || settings;

    const live = settings.events?.find(e => e.isLive);
    liveEventName.textContent = live?.name || "‚Äî";

    // Populate event dropdown
    const current = eventSel.value || "";
    eventSel.innerHTML = `<option value="">All Events</option>` + (settings.events || []).map(e =>
      `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}${e.isLive ? " (LIVE)" : ""}</option>`
    ).join("");
    eventSel.value = (settings.events || []).some(e => e.id === current) ? current : "";

    render();
  });

  socket.on("scoreUpdate", (row) => {
    scores.push(row);
    pulseIds.set(row.id, Date.now() + 1400);
    render();
  });

  socket.on("scoreReplace", (row) => {
    const idx = scores.findIndex(s => s.id === row.id);
    if (idx !== -1) scores[idx] = row; else scores.push(row);
    pulseIds.set(row.id, Date.now() + 1400);
    render();
  });

  socket.on("attemptAdded", (att) => {
    attempts.push(att);
    // keep attempts from growing forever in-browser
    if (attempts.length > 3000) attempts.splice(0, attempts.length - 3000);
    if (activeView === "attempts") renderAttempts();
  });

  socket.on("clearEvent", ({ eventId }) => {
    scores = scores.filter(s => s.eventId !== eventId);
    attempts = attempts.filter(a => a.eventId !== eventId);
    render();
  });

  socket.on("clearAll", () => {
    scores = [];
    attempts = [];
    render();
  });

  // Boot
  setActiveGame("");
  setView("leaderboard");
  fetchAttemptsInitial();
</script>
</body>
</html>
