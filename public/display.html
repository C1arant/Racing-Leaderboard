<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leaderboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root{
      --t-title: clamp(26px, 2.4vw, 48px);
      --t-sub: clamp(12px, 1.0vw, 16px);
      --t-base: clamp(13px, 1.05vw, 18px);
      --t-time: clamp(16px, 1.6vw, 26px);
    }
    .t-title{ font-size: var(--t-title); }
    .t-sub{ font-size: var(--t-sub); }
    .t-base{ font-size: var(--t-base); }
    .t-time{ font-size: var(--t-time); }

    .pulse-new { animation: pulseNew 1.1s ease-out 1; }
    @keyframes pulseNew {
      0%   { box-shadow: 0 0 0 0 rgba(239,68,68,0.28); background-color: rgba(239,68,68,0.08); }
      60%  { box-shadow: 0 0 0 22px rgba(239,68,68,0.00); }
      100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.00); background-color: transparent; }
    }
  </style>
</head>

<body class="min-h-screen bg-black text-white">
  <div class="max-w-[1800px] mx-auto px-6 py-8">
    <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
      <div class="min-w-0">
        <p class="text-xs uppercase tracking-[0.35em] text-red-500">Racing Leaderboard</p>
        <div class="flex items-center gap-3 min-w-0 mt-1">
          <h1 class="t-title font-black tracking-tight truncate">Time Trial Rankings</h1>
          <span class="t-sub inline-flex items-center gap-2 bg-black/90 border border-white/10 rounded-md px-3 py-2 text-white">
            Track: <span id="activeTrackLabel" class="font-semibold">—</span>
          </span>
        </div>
        <p class="t-sub text-white/60 mt-2">Filter by driver or track. Ratings use Driver Rating (DR).</p>
      </div>
      <nav class="flex items-center gap-2 t-sub">
        <a href="/fullscreen" class="px-4 py-2 rounded-md bg-black/90 border border-white/10 text-white hover:bg-black">Fullscreen</a>
        <a href="/admin" class="px-4 py-2 rounded-md bg-black/90 border border-white/10 text-white hover:bg-black">Admin</a>
      </nav>
    </header>

    <div class="grid grid-cols-12 gap-6">
      <aside class="col-span-12 lg:col-span-3 space-y-6">
        <section class="rounded-md border border-white/10 bg-black/90 p-5 space-y-4">
          <div>
            <label class="t-sub text-white/60">Search</label>
            <input id="q" placeholder="Driver / track / car / course"
              class="t-base mt-2 w-full bg-black border border-white/10 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" />
            <button id="clearQ" class="t-base mt-2 px-3 py-2 rounded-md border border-white/10 bg-black hover:bg-black transition w-full">Clear search</button>
          </div>

          <div>
            <label class="t-sub text-white/60">Track filter</label>
            <input id="trackFilter" placeholder="Track name"
              class="t-base mt-2 w-full bg-black border border-white/10 rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-red-500/50" />
            <button id="clearTrack" class="t-base mt-2 px-3 py-2 rounded-md border border-white/10 bg-black hover:bg-black transition w-full">Clear track</button>
          </div>
        </section>

        <section class="rounded-md border border-white/10 bg-black/90 p-5 space-y-3">
          <h2 class="text-base font-semibold">Snapshot</h2>
          <div class="rounded-lg border border-white/10 bg-black/70 p-3">
            <p class="text-xs text-white/60">Total entries</p>
            <p id="statTotal" class="text-2xl font-bold">0</p>
          </div>
          <div class="rounded-lg border border-white/10 bg-black/70 p-3">
            <p class="text-xs text-white/60">Top driver</p>
            <p id="statDriver" class="text-lg font-semibold">—</p>
            <p id="statTime" class="text-xs text-white/60">—</p>
          </div>
        </section>
      </aside>

      <main class="col-span-12 lg:col-span-9 space-y-6">
        <section id="leaderboardView" class="rounded-md border border-white/10 bg-black/90 overflow-hidden">
          <div class="flex items-center justify-between px-5 py-4 bg-black/60">
            <div>
              <h2 class="text-lg font-semibold">Leaderboard</h2>
              <p class="t-sub text-white/60">Fastest time first</p>
            </div>
            <span id="lbCount" class="t-sub text-white/60">0 entries</span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full t-base">
              <thead class="bg-black/60 text-white/60">
                <tr>
                  <th class="text-left px-5 py-4 w-16">#</th>
                  <th class="text-left px-5 py-4">Driver</th>
                  <th class="text-left px-5 py-4 w-44">Driver Rating (DR)</th>
                  <th class="text-left px-5 py-4 w-36">Time</th>
                  <th class="text-left px-5 py-4">Track</th>
                  <th class="text-left px-5 py-4">Car</th>
                  <th class="text-left px-5 py-4 w-64">Cohort / Course</th>
                </tr>
              </thead>
              <tbody id="lbRows" class="divide-y divide-white/10"></tbody>
            </table>
          </div>
        </section>

      </main>
    </div>
  </div>

<script>
  const socket = io();

  const q = document.getElementById("q");
  const clearQ = document.getElementById("clearQ");
  const trackFilter = document.getElementById("trackFilter");
  const clearTrack = document.getElementById("clearTrack");
  const activeTrackLabel = document.getElementById("activeTrackLabel");

  const lbRows = document.getElementById("lbRows");
  const lbCount = document.getElementById("lbCount");

  const statTotal = document.getElementById("statTotal");
  const statDriver = document.getElementById("statDriver");
  const statTime = document.getElementById("statTime");

  let scores = [];
  let ratings = {};
  let settings = { defaultTrack: "spa" };

  const pulseIds = new Map();

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function timeToMs(t) {
    const str = String(t).trim();
    if (/^\d+:\d{2}\.\d{3}$/.test(str)) {
      const [m, rest] = str.split(":");
      const [s, ms] = rest.split(".");
      return (parseInt(m,10) * 60 + parseInt(s,10)) * 1000 + parseInt(ms,10);
    }
    if (/^\d+\.\d{3}$/.test(str)) {
      const [s, ms] = str.split(".");
      return parseInt(s,10) * 1000 + parseInt(ms,10);
    }
    return Infinity;
  }

  function cleanupPulse() {
    const now = Date.now();
    for (const [id, exp] of pulseIds.entries()) if (exp <= now) pulseIds.delete(id);
  }

  function getRatingKey(game, first, last) {
    return `${String(game).trim()}|${String(first).trim().toLowerCase()}|${String(last).trim().toLowerCase()}`;
  }

  function getRatingDisplay(s) {
    const key = getRatingKey(s.game, s.first, s.last);
    const rating = ratings[key];
    if (!rating) return "—";
    const delta = rating.lastChange;
    const sign = delta > 0 ? "+" : "";
    return `${rating.rating} (${sign}${delta})`;
  }

  function passesFilters(item) {
    const qq = q.value.trim().toLowerCase();
    const tf = trackFilter.value.trim().toLowerCase();

    if (tf && !String(item.track || "").toLowerCase().includes(tf)) return false;

    if (qq) {
      const hay = `${item.first} ${item.last} ${item.track} ${item.car} ${item.game} ${item.course} ${item.cohort}`.toLowerCase();
      if (!hay.includes(qq)) return false;
    }
    return true;
  }

  function updateStats(list) {
    statTotal.textContent = list.length;
    if (!list.length) {
      statDriver.textContent = "—";
      statTime.textContent = "—";
      return;
    }
    statDriver.textContent = `${list[0].first} ${list[0].last}`;
    statTime.textContent = `Best: ${list[0].time} • ${list[0].track}`;
  }

  function renderLeaderboard() {
    cleanupPulse();

    let list = scores.filter(passesFilters);
    list.sort((a,b) => timeToMs(a.time) - timeToMs(b.time));

    const view = list.slice(0, 40);

    lbRows.innerHTML = view.map((s, i) => {
      const rank = i + 1;
      const pulse = pulseIds.has(s.id) ? "pulse-new" : "";
      return `
        <tr class="${pulse} hover:bg-black/30">
          <td class="px-5 py-4 text-white/60 font-semibold">${rank}</td>
          <td class="px-5 py-4 text-white font-medium">${escapeHtml(`${s.first} ${s.last}`)}</td>
          <td class="px-5 py-4 text-red-300 font-semibold">${escapeHtml(getRatingDisplay(s))}</td>
          <td class="px-5 py-4 text-white font-extrabold t-time tracking-tight">${escapeHtml(s.time)}</td>
          <td class="px-5 py-4 text-white">${escapeHtml(s.track)}</td>
          <td class="px-5 py-4 text-white/60">${escapeHtml(s.car || "—")}</td>
          <td class="px-5 py-4 text-white/60">${escapeHtml(`${s.cohort || "Guest"} • ${s.course || "—"}`)}</td>
        </tr>
      `;
    }).join("");

    lbCount.textContent = `${list.length} entries (showing ${view.length})`;
    updateStats(list);
  }

  function render() {
    renderLeaderboard();
  }

  clearQ.addEventListener("click", () => { q.value = ""; render(); });
  clearTrack.addEventListener("click", () => { trackFilter.value = ""; render(); });
  q.addEventListener("input", () => render());
  trackFilter.addEventListener("input", () => render());

  socket.on("loadScores", (existing) => {
    scores = Array.isArray(existing) ? existing : [];
    render();
  });

  socket.on("ratingsUpdate", (r) => {
    ratings = r || {};
    render();
  });

  socket.on("settingsUpdate", (s) => {
    settings = s || settings;
    activeTrackLabel.textContent = settings.defaultTrack || "—";
    render();
  });

  socket.on("scoreUpdate", (row) => {
    scores.push(row);
    pulseIds.set(row.id, Date.now() + 1400);
    render();
  });

  socket.on("scoreReplace", (row) => {
    const idx = scores.findIndex(s => s.id === row.id);
    if (idx !== -1) scores[idx] = row; else scores.push(row);
    pulseIds.set(row.id, Date.now() + 1400);
    render();
  });

  socket.on("clearAll", () => {
    scores = [];
    render();
  });

  render();
</script>
</body>
</html>
