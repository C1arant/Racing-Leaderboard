<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Leaderboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    /* Big-screen scaling */
    :root{
      --t-base: clamp(12px, 1.05vw, 18px);
      --t-title: clamp(22px, 2.2vw, 44px);
      --t-sub: clamp(12px, 1.0vw, 16px);
      --t-time: clamp(16px, 1.7vw, 26px);
    }
    .t-base{ font-size: var(--t-base); }
    .t-title{ font-size: var(--t-title); }
    .t-sub{ font-size: var(--t-sub); }
    .t-time{ font-size: var(--t-time); }

    /* Smooth updates */
    .row-anim { transition: background-color 300ms ease, transform 300ms ease, border-color 300ms ease; }
    .pulse-new {
      animation: pulseNew 1.1s ease-out 1;
    }
    @keyframes pulseNew {
      0%   { box-shadow: 0 0 0 0 rgba(16,185,129,0.30); background-color: rgba(16,185,129,0.06); }
      60%  { box-shadow: 0 0 0 22px rgba(16,185,129,0.00); }
      100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.00); background-color: transparent; }
    }

    /* Podium accent shimmer */
    .podium-glow {
      position: relative;
      overflow: hidden;
    }
    .podium-glow::after{
      content:"";
      position:absolute;
      top:-60%;
      left:-40%;
      width: 60%;
      height: 220%;
      transform: rotate(18deg);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
      animation: shimmer 3.2s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes shimmer{
      0% { left:-60%; }
      60% { left:140%; }
      100% { left:140%; }
    }
  </style>
</head>

<body class="min-h-screen bg-zinc-950 text-zinc-100">
  <div class="max-w-[1700px] mx-auto px-6 py-6">
    <!-- Header -->
    <div class="flex items-end justify-between gap-4 mb-5">
      <div>
        <div class="flex items-center gap-3">
          <h1 class="t-title font-extrabold tracking-tight">üèÅ Live Leaderboard</h1>
          <span id="eventPill" class="t-sub inline-flex items-center gap-2 bg-zinc-900/60 border border-zinc-800 rounded-full px-3 py-2 text-zinc-200">
            Event: <span id="eventName" class="font-semibold">Open Practice</span>
          </span>
        </div>
        <p class="t-sub text-zinc-400 mt-1">Auto-updating ‚Ä¢ Broadcast-style display</p>
      </div>

      <div class="flex items-center gap-2 t-sub">
        <span class="inline-flex items-center gap-2 bg-zinc-900/60 border border-zinc-800 rounded-full px-3 py-2">
          <span id="liveDot" class="w-2 h-2 rounded-full bg-emerald-500"></span>
          <span id="liveLabel">Live</span>
        </span>
        <span id="cycleBadge" class="hidden inline-flex items-center gap-2 bg-zinc-900/60 border border-zinc-800 rounded-full px-3 py-2 text-zinc-300">
          TV Cycle
        </span>
      </div>
    </div>

    <div class="grid grid-cols-12 gap-4">
      <!-- LEFT: Podium + Key -->
      <div class="col-span-12 xl:col-span-4 space-y-4">
        <!-- Podium -->
        <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 shadow">
          <div class="flex items-center justify-between mb-3">
            <h2 class="t-base font-semibold">Podium</h2>
            <span id="modePill" class="t-sub inline-flex items-center gap-2 bg-zinc-950 border border-zinc-800 rounded-full px-3 py-2 text-zinc-200">
              Mode: <span id="modeLabel" class="font-semibold">Best per driver</span>
            </span>
          </div>

          <div class="grid grid-cols-1 gap-3">
            <div id="podium1" class="podium-glow rounded-2xl border border-amber-500/35 bg-gradient-to-r from-amber-500/18 to-zinc-950/0 p-4">
              <div class="flex items-center justify-between">
                <div class="t-base font-semibold">ü•á P1</div>
                <div class="t-sub text-zinc-300" id="p1_meta">‚Äî</div>
              </div>
              <div class="mt-2">
                <div class="t-base font-semibold" id="p1_driver">‚Äî</div>
                <div class="t-time font-extrabold tracking-tight" id="p1_time">‚Äî</div>
                <div class="t-sub text-zinc-300 mt-1" id="p1_detail">‚Äî</div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div id="podium2" class="rounded-2xl border border-zinc-200/25 bg-gradient-to-r from-zinc-200/10 to-zinc-950/0 p-4">
                <div class="flex items-center justify-between">
                  <div class="t-base font-semibold">ü•à P2</div>
                  <div class="t-sub text-zinc-300" id="p2_meta">‚Äî</div>
                </div>
                <div class="mt-2">
                  <div class="t-base font-semibold" id="p2_driver">‚Äî</div>
                  <div class="t-time font-extrabold tracking-tight" id="p2_time">‚Äî</div>
                  <div class="t-sub text-zinc-300 mt-1" id="p2_detail">‚Äî</div>
                </div>
              </div>

              <div id="podium3" class="rounded-2xl border border-orange-300/25 bg-gradient-to-r from-orange-500/12 to-zinc-950/0 p-4">
                <div class="flex items-center justify-between">
                  <div class="t-base font-semibold">ü•â P3</div>
                  <div class="t-sub text-zinc-300" id="p3_meta">‚Äî</div>
                </div>
                <div class="mt-2">
                  <div class="t-base font-semibold" id="p3_driver">‚Äî</div>
                  <div class="t-time font-extrabold tracking-tight" id="p3_time">‚Äî</div>
                  <div class="t-sub text-zinc-300 mt-1" id="p3_detail">‚Äî</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Key -->
        <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 shadow">
          <div class="flex items-center justify-between">
            <h2 class="t-base font-semibold">Key</h2>
            <span class="t-sub text-zinc-400">Cohort / Course</span>
          </div>

          <div class="mt-3 space-y-2 t-base">
            <div class="flex items-center justify-between">
              <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded bg-emerald-400"></span> Staff</span>
              <span class="text-zinc-400">Staff</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded bg-sky-400"></span> Y1</span>
              <span class="text-zinc-400">Year 1</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded bg-violet-400"></span> Y2</span>
              <span class="text-zinc-400">Year 2</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded bg-amber-400"></span> Y3</span>
              <span class="text-zinc-400">Year 3</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded bg-zinc-500"></span> Guest</span>
              <span class="text-zinc-400">Other</span>
            </div>
          </div>

          <div class="mt-4 border-t border-zinc-800 pt-4">
            <div class="t-sub text-zinc-400">
              Top 20 shown ‚Ä¢ fastest first ‚Ä¢ new PBs pulse green
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Tabs + Table -->
      <div class="col-span-12 xl:col-span-8">
        <!-- Controls -->
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <button class="tab t-base px-4 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition" data-game="">
            Mixed
          </button>
          <button class="tab t-base px-4 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition" data-game="Assetto Corsa">
            Assetto Corsa
          </button>
          <button class="tab t-base px-4 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition" data-game="F1 25">
            F1 25
          </button>

          <div class="ml-auto flex flex-wrap items-center gap-2">
            <input id="trackFilter" placeholder="Filter track (optional)"
              class="t-base w-72 max-w-full bg-zinc-900/60 border border-zinc-800 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-600" />
            <button id="clearTrack"
              class="t-base px-3 py-2 rounded-xl border border-zinc-800 bg-zinc-900/60 hover:bg-zinc-900 transition">
              Clear
            </button>
          </div>
        </div>

        <!-- Table -->
        <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden shadow">
          <div class="overflow-x-auto">
            <table class="w-full t-base">
              <thead class="bg-zinc-950/60 text-zinc-300">
                <tr>
                  <th class="text-left px-5 py-4 w-16">#</th>
                  <th class="text-left px-5 py-4">Driver</th>
                  <th class="text-left px-5 py-4 w-36">Time</th>
                  <th class="text-left px-5 py-4 w-36">Game</th>
                  <th class="text-left px-5 py-4">Track</th>
                  <th class="text-left px-5 py-4">Car</th>
                  <th class="text-left px-5 py-4 w-32">Tag</th>
                </tr>
              </thead>
              <tbody id="rows" class="divide-y divide-zinc-800"></tbody>
            </table>
          </div>

          <div class="px-5 py-3 bg-zinc-950/40 t-base text-zinc-400 flex justify-between">
            <span id="count">0 entries</span>
            <span id="hint">Filtered by event ‚Ä¢ Mixed/AC/F1 tabs</span>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const socket = io();

  const rows = document.getElementById("rows");
  const count = document.getElementById("count");
  const trackFilter = document.getElementById("trackFilter");
  const clearTrack = document.getElementById("clearTrack");
  const tabs = Array.from(document.querySelectorAll(".tab"));

  const cycleBadge = document.getElementById("cycleBadge");
  const liveLabel = document.getElementById("liveLabel");
  const liveDot = document.getElementById("liveDot");
  const eventNameEl = document.getElementById("eventName");
  const modeLabel = document.getElementById("modeLabel");

  // Podium fields
  const P = {
    p1_driver: document.getElementById("p1_driver"),
    p1_time: document.getElementById("p1_time"),
    p1_detail: document.getElementById("p1_detail"),
    p1_meta: document.getElementById("p1_meta"),
    p2_driver: document.getElementById("p2_driver"),
    p2_time: document.getElementById("p2_time"),
    p2_detail: document.getElementById("p2_detail"),
    p2_meta: document.getElementById("p2_meta"),
    p3_driver: document.getElementById("p3_driver"),
    p3_time: document.getElementById("p3_time"),
    p3_detail: document.getElementById("p3_detail"),
    p3_meta: document.getElementById("p3_meta"),
  };

  let scores = [];
  let settings = { eventName: "Open Practice", bestPerDriver: true, tvCycleEnabled: false };
  let activeGame = ""; // "" = Mixed

  // Track recently updated ids -> pulse in table
  const pulseIds = new Map(); // id -> expiry timestamp

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function timeToMs(t) {
    const str = String(t).trim();
    if (/^\d+:\d{2}\.\d{3}$/.test(str)) {
      const [m, rest] = str.split(":");
      const [s, ms] = rest.split(".");
      return (parseInt(m,10) * 60 + parseInt(s,10)) * 1000 + parseInt(ms,10);
    }
    if (/^\d+\.\d{3}$/.test(str)) {
      const [s, ms] = str.split(".");
      return parseInt(s,10) * 1000 + parseInt(ms,10);
    }
    return Infinity;
  }

  function podiumClass(rank) {
    if (rank === 1) return "bg-gradient-to-r from-amber-500/14 to-transparent border-l-4 border-amber-400";
    if (rank === 2) return "bg-gradient-to-r from-zinc-200/10 to-transparent border-l-4 border-zinc-200/70";
    if (rank === 3) return "bg-gradient-to-r from-orange-500/12 to-transparent border-l-4 border-orange-300/90";
    return "";
  }

  function cohortBadge(cohort, course) {
    const c = String(cohort || "Guest").toUpperCase();
    const courseText = String(course || "‚Äî").trim();

    const map = {
      "STAFF": "bg-emerald-500/15 text-emerald-200 border-emerald-500/40",
      "Y1": "bg-sky-500/15 text-sky-200 border-sky-500/40",
      "Y2": "bg-violet-500/15 text-violet-200 border-violet-500/40",
      "Y3": "bg-amber-500/15 text-amber-200 border-amber-500/40",
      "GUEST": "bg-zinc-600/15 text-zinc-200 border-zinc-600/40",
    };
    const cls = map[c] || map["GUEST"];

    return `
      <span class="inline-flex items-center gap-2 border ${cls} rounded-full px-3 py-1 whitespace-nowrap">
        <span class="font-semibold">${escapeHtml(cohort || "Guest")}</span>
        <span class="opacity-80">${escapeHtml(courseText)}</span>
      </span>
    `;
  }

  function setActiveTab(gameValue) {
    activeGame = gameValue;
    tabs.forEach(btn => {
      const on = btn.dataset.game === activeGame;
      btn.classList.toggle("bg-white", on);
      btn.classList.toggle("text-black", on);
      btn.classList.toggle("font-semibold", on);
    });
    render();
  }

  function passesFilters(score) {
    const tf = trackFilter.value.trim().toLowerCase();
    if (activeGame && score.game !== activeGame) return false;
    if (tf && !String(score.track).toLowerCase().includes(tf)) return false;

    // Keep display clean for events: show current event only (if present)
    if (settings?.eventName && score.event && score.event !== settings.eventName) return false;

    return true;
  }

  function bestPerDriver(list) {
    // Best per person per game+track+event (matches server bucket)
    const map = new Map();
    for (const s of list) {
      const key = `${(s.first||"").toLowerCase()}|${(s.last||"").toLowerCase()}|${s.game}|${(s.track||"").toLowerCase()}|${s.event||""}`;
      const existing = map.get(key);
      if (!existing || timeToMs(s.time) < timeToMs(existing.time)) {
        map.set(key, s);
      }
    }
    return Array.from(map.values());
  }

  function setPodium(rank, s) {
    const id = rank === 1 ? "p1" : rank === 2 ? "p2" : "p3";
    if (!s) {
      P[`${id}_driver`].textContent = "‚Äî";
      P[`${id}_time`].textContent = "‚Äî";
      P[`${id}_detail`].textContent = "‚Äî";
      P[`${id}_meta`].textContent = "‚Äî";
      return;
    }
    const driver = `${s.first} ${s.last}`.trim();
    P[`${id}_driver`].textContent = driver;
    P[`${id}_time`].textContent = s.time || "‚Äî";
    P[`${id}_detail`].textContent = `${s.game} ‚Ä¢ ${s.track} ‚Ä¢ ${s.car || "‚Äî"}`;
    P[`${id}_meta`].textContent = `${s.cohort || "Guest"} ‚Ä¢ ${s.course || "‚Äî"}`;
  }

  function cleanupPulse() {
    const now = Date.now();
    for (const [id, expiry] of pulseIds.entries()) {
      if (expiry <= now) pulseIds.delete(id);
    }
  }

  function render() {
    cleanupPulse();

    let filtered = scores.filter(passesFilters);

    // Even though the server already enforces no duplicates, keep this for safety.
    if (settings.bestPerDriver) filtered = bestPerDriver(filtered);

    filtered.sort((a, b) => timeToMs(a.time) - timeToMs(b.time));

    // Podium
    setPodium(1, filtered[0]);
    setPodium(2, filtered[1]);
    setPodium(3, filtered[2]);

    // Table (Top 20)
    const view = filtered.slice(0, 20);

    rows.innerHTML = view.map((s, i) => {
      const rank = i + 1;
      const driver = `${escapeHtml(s.first)} ${escapeHtml(s.last)}`.trim();
      const time = escapeHtml(s.time);
      const game = escapeHtml(s.game);
      const track = escapeHtml(s.track);
      const car = escapeHtml(s.car || "");
      const tag = cohortBadge(s.cohort, s.course);

      const pulse = pulseIds.has(s.id) ? "pulse-new" : "";
      return `
        <tr class="row-anim hover:bg-zinc-950/30 ${podiumClass(rank)} ${pulse}">
          <td class="px-5 py-4 text-zinc-300 font-semibold">${rank}</td>
          <td class="px-5 py-4 text-white font-medium">${driver}</td>
          <td class="px-5 py-4 text-white font-extrabold t-time tracking-tight">${time}</td>
          <td class="px-5 py-4 text-zinc-200">${game}</td>
          <td class="px-5 py-4 text-zinc-100">${track}</td>
          <td class="px-5 py-4 text-zinc-300">${car}</td>
          <td class="px-5 py-4">${tag}</td>
        </tr>
      `;
    }).join("");

    count.textContent = `${filtered.length} entr${filtered.length === 1 ? "y" : "ies"} (showing ${view.length})`;
    eventNameEl.textContent = settings.eventName || "Open Practice";
    modeLabel.textContent = settings.bestPerDriver ? "Best per driver" : "All submissions";
  }

  // UI handlers
  tabs.forEach(btn => btn.addEventListener("click", () => setActiveTab(btn.dataset.game)));
  trackFilter.addEventListener("input", render);
  clearTrack.addEventListener("click", () => { trackFilter.value = ""; render(); });

  // Socket events
  socket.on("loadScores", (existing) => {
    scores = Array.isArray(existing) ? existing : [];
    setActiveTab(""); // default Mixed
  });

  socket.on("settingsUpdate", (s) => {
    settings = s || settings;
    cycleBadge.classList.toggle("hidden", !settings.tvCycleEnabled);
    render();
  });

  // New score (new row) -> pulse
  socket.on("scoreUpdate", (score) => {
    scores.push(score);
    if (score?.id) pulseIds.set(score.id, Date.now() + 1400);
    render();
  });

  // Replacement score (PB update) -> replace + pulse
  socket.on("scoreReplace", (score) => {
    const idx = scores.findIndex(s => s.id === score.id);
    if (idx !== -1) scores[idx] = score;
    else scores.push(score);
    if (score?.id) pulseIds.set(score.id, Date.now() + 1400);
    render();
  });

  socket.on("clearAll", () => { scores = []; render(); });
  socket.on("clearEvent", ({ eventName }) => {
    scores = scores.filter(s => s.event !== eventName);
    render();
  });

  // TV cycle steps from admin (optional)
  socket.on("tvCycleStep", ({ game }) => setActiveTab(game ?? ""));

  // Connection indicator
  socket.on("disconnect", () => {
    liveLabel.textContent = "Disconnected";
    liveDot.classList.remove("bg-emerald-500");
    liveDot.classList.add("bg-red-500");
  });
  socket.on("connect", () => {
    liveLabel.textContent = "Live";
    liveDot.classList.remove("bg-red-500");
    liveDot.classList.add("bg-emerald-500");
  });
</script>
</body>
</html>
