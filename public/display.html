<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leaderboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root{
      --t-title: clamp(26px, 2.4vw, 48px);
      --t-sub: clamp(12px, 1.0vw, 16px);
      --t-base: clamp(13px, 1.05vw, 18px);
      --t-time: clamp(16px, 1.6vw, 26px);
    }
    .t-title{ font-size: var(--t-title); }
    .t-sub{ font-size: var(--t-sub); }
    .t-base{ font-size: var(--t-base); }
    .t-time{ font-size: var(--t-time); }

    .pulse-new { animation: pulseNew 1.1s ease-out 1; }
    @keyframes pulseNew {
      0%   { box-shadow: 0 0 0 0 rgba(14,165,233,0.30); background-color: rgba(14,165,233,0.06); }
      60%  { box-shadow: 0 0 0 22px rgba(14,165,233,0.00); }
      100% { box-shadow: 0 0 0 0 rgba(14,165,233,0.00); background-color: transparent; }
    }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-[1800px] mx-auto px-6 py-8">
    <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
      <div class="min-w-0">
        <p class="text-xs uppercase tracking-[0.35em] text-slate-500">Racing Leaderboard</p>
        <div class="flex items-center gap-3 min-w-0 mt-1">
          <h1 class="t-title font-black tracking-tight truncate">Time Trial Rankings</h1>
          <span id="liveEventBadge" class="t-sub inline-flex items-center gap-2 bg-slate-900/60 border border-slate-800 rounded-full px-3 py-2 text-slate-200">
            LIVE: <span id="liveEventName" class="font-semibold">—</span>
          </span>
        </div>
        <p class="t-sub text-slate-400 mt-2">Filter by event, track, or game. Ratings follow iRacing-style strength-of-field scoring.</p>
      </div>
      <nav class="flex items-center gap-2 t-sub">
        <a href="/fullscreen" class="px-4 py-2 rounded-full bg-slate-900/60 border border-slate-800 text-slate-200 hover:bg-slate-900">Fullscreen</a>
        <a href="/admin" class="px-4 py-2 rounded-full bg-slate-900/60 border border-slate-800 text-slate-200 hover:bg-slate-900">Admin</a>
      </nav>
    </header>

    <div class="grid grid-cols-12 gap-6">
      <aside class="col-span-12 lg:col-span-3 space-y-6">
        <section class="rounded-3xl border border-slate-800 bg-slate-900/60 p-5">
          <h2 class="text-base font-semibold">View</h2>
          <div class="flex gap-2 mt-3">
            <button id="tabLeaderboard" class="t-base flex-1 px-3 py-2 rounded-xl bg-white text-black font-semibold">Leaderboard</button>
            <button id="tabAttempts" class="t-base flex-1 px-3 py-2 rounded-xl border border-slate-800 bg-slate-950 hover:bg-slate-900 transition">History</button>
          </div>
        </section>

        <section class="rounded-3xl border border-slate-800 bg-slate-900/60 p-5 space-y-4">
          <div>
            <label class="t-sub text-slate-400">Search</label>
            <input id="q" placeholder="Driver / track / car / course"
              class="t-base mt-2 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-slate-600" />
            <button id="clearQ" class="t-base mt-2 px-3 py-2 rounded-xl border border-slate-800 bg-slate-950 hover:bg-slate-900 transition w-full">Clear search</button>
          </div>

          <div>
            <label class="t-sub text-slate-400">Event</label>
            <select id="eventSel" class="t-base mt-2 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-slate-600">
              <option value="">All Events</option>
            </select>
          </div>

          <div>
            <label class="t-sub text-slate-400">Game</label>
            <div class="mt-2 grid grid-cols-3 gap-2">
              <button class="game t-base px-3 py-2 rounded-xl border border-slate-800 bg-slate-950 hover:bg-slate-900 transition" data-game="">
                Mixed
              </button>
              <button class="game t-base px-3 py-2 rounded-xl border border-slate-800 bg-slate-950 hover:bg-slate-900 transition" data-game="Assetto Corsa">
                AC
              </button>
              <button class="game t-base px-3 py-2 rounded-xl border border-slate-800 bg-slate-950 hover:bg-slate-900 transition" data-game="F1 25">
                F1 25
              </button>
            </div>
          </div>

          <div>
            <label class="t-sub text-slate-400">Track filter</label>
            <input id="trackFilter" placeholder="Track name"
              class="t-base mt-2 w-full bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-slate-600" />
            <button id="clearTrack" class="t-base mt-2 px-3 py-2 rounded-xl border border-slate-800 bg-slate-950 hover:bg-slate-900 transition w-full">Clear track</button>
          </div>
        </section>

        <section class="rounded-3xl border border-slate-800 bg-slate-900/60 p-5 space-y-3">
          <h2 class="text-base font-semibold">Snapshot</h2>
          <div class="rounded-2xl border border-slate-800 bg-slate-950/70 p-3">
            <p class="text-xs text-slate-400">Total entries</p>
            <p id="statTotal" class="text-2xl font-bold">0</p>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-950/70 p-3">
            <p class="text-xs text-slate-400">Top driver</p>
            <p id="statDriver" class="text-lg font-semibold">—</p>
            <p id="statTime" class="text-xs text-slate-400">—</p>
          </div>
        </section>
      </aside>

      <main class="col-span-12 lg:col-span-9 space-y-6">
        <section id="leaderboardView" class="rounded-3xl border border-slate-800 bg-slate-900/60 overflow-hidden">
          <div class="flex items-center justify-between px-5 py-4 bg-slate-950/60">
            <div>
              <h2 class="text-lg font-semibold">Leaderboard</h2>
              <p class="t-sub text-slate-400">Fastest time first</p>
            </div>
            <span id="lbCount" class="t-sub text-slate-400">0 entries</span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full t-base">
              <thead class="bg-slate-950/60 text-slate-300">
                <tr>
                  <th class="text-left px-5 py-4 w-16">#</th>
                  <th class="text-left px-5 py-4">Driver</th>
                  <th class="text-left px-5 py-4 w-44">iRating</th>
                  <th class="text-left px-5 py-4 w-36">Time</th>
                  <th class="text-left px-5 py-4 w-36">Game</th>
                  <th class="text-left px-5 py-4">Track</th>
                  <th class="text-left px-5 py-4">Car</th>
                  <th class="text-left px-5 py-4 w-64">Event</th>
                </tr>
              </thead>
              <tbody id="lbRows" class="divide-y divide-slate-800"></tbody>
            </table>
          </div>
        </section>

        <section id="attemptsView" class="hidden rounded-3xl border border-slate-800 bg-slate-900/60 overflow-hidden">
          <div class="flex items-center justify-between px-5 py-4 bg-slate-950/60">
            <div>
              <h2 class="text-lg font-semibold">Lap History</h2>
              <p class="t-sub text-slate-400">Newest first</p>
            </div>
            <span id="attCount" class="t-sub text-slate-400">0 laps</span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full t-base">
              <thead class="bg-slate-950/60 text-slate-300">
                <tr>
                  <th class="text-left px-5 py-4 w-44">When</th>
                  <th class="text-left px-5 py-4">Driver</th>
                  <th class="text-left px-5 py-4 w-36">Time</th>
                  <th class="text-left px-5 py-4 w-36">Game</th>
                  <th class="text-left px-5 py-4">Track</th>
                  <th class="text-left px-5 py-4">Car</th>
                  <th class="text-left px-5 py-4 w-64">Event</th>
                </tr>
              </thead>
              <tbody id="attRows" class="divide-y divide-slate-800"></tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </div>

<script>
  const socket = io();

  // Tabs
  const tabLeaderboard = document.getElementById("tabLeaderboard");
  const tabAttempts = document.getElementById("tabAttempts");
  const leaderboardView = document.getElementById("leaderboardView");
  const attemptsView = document.getElementById("attemptsView");

  // Inputs
  const q = document.getElementById("q");
  const clearQ = document.getElementById("clearQ");
  const eventSel = document.getElementById("eventSel");
  const trackFilter = document.getElementById("trackFilter");
  const clearTrack = document.getElementById("clearTrack");
  const gameButtons = Array.from(document.querySelectorAll(".game"));

  // UI
  const liveEventName = document.getElementById("liveEventName");

  // Leaderboard table
  const lbRows = document.getElementById("lbRows");
  const lbCount = document.getElementById("lbCount");

  // Attempts table
  const attRows = document.getElementById("attRows");
  const attCount = document.getElementById("attCount");

  // Stats
  const statTotal = document.getElementById("statTotal");
  const statDriver = document.getElementById("statDriver");
  const statTime = document.getElementById("statTime");

  // Data
  let scores = [];
  let attempts = [];
  let ratings = {};
  let settings = { events: [], fullscreen: { eventId: "", game: "" } };

  let activeGame = ""; // "" = Mixed
  let activeView = "leaderboard"; // or "attempts"

  const pulseIds = new Map(); // row id -> expiry

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function timeToMs(t) {
    const str = String(t).trim();
    if (/^\d+:\d{2}\.\d{3}$/.test(str)) {
      const [m, rest] = str.split(":");
      const [s, ms] = rest.split(".");
      return (parseInt(m,10) * 60 + parseInt(s,10)) * 1000 + parseInt(ms,10);
    }
    if (/^\d+\.\d{3}$/.test(str)) {
      const [s, ms] = str.split(".");
      return parseInt(s,10) * 1000 + parseInt(ms,10);
    }
    return Infinity;
  }

  function setActiveGame(game) {
    activeGame = game;
    gameButtons.forEach(b => {
      const on = b.dataset.game === activeGame;
      b.classList.toggle("bg-white", on);
      b.classList.toggle("text-black", on);
      b.classList.toggle("font-semibold", on);
    });
    render();
  }

  function setView(view) {
    activeView = view;
    const lbOn = view === "leaderboard";
    leaderboardView.classList.toggle("hidden", !lbOn);
    attemptsView.classList.toggle("hidden", lbOn);

    tabLeaderboard.className = lbOn
      ? "t-base flex-1 px-3 py-2 rounded-xl bg-white text-black font-semibold"
      : "t-base flex-1 px-3 py-2 rounded-xl border border-slate-800 bg-slate-950 hover:bg-slate-900 transition";

    tabAttempts.className = !lbOn
      ? "t-base flex-1 px-3 py-2 rounded-xl bg-white text-black font-semibold"
      : "t-base flex-1 px-3 py-2 rounded-xl border border-slate-800 bg-slate-950 hover:bg-slate-900 transition";

    render();
  }

  tabLeaderboard.addEventListener("click", () => setView("leaderboard"));
  tabAttempts.addEventListener("click", () => setView("attempts"));

  clearQ.addEventListener("click", () => { q.value = ""; render(); });
  clearTrack.addEventListener("click", () => { trackFilter.value = ""; render(); });
  q.addEventListener("input", () => render());
  eventSel.addEventListener("change", () => render());
  trackFilter.addEventListener("input", () => render());
  gameButtons.forEach(b => b.addEventListener("click", () => setActiveGame(b.dataset.game)));

  function cleanupPulse() {
    const now = Date.now();
    for (const [id, exp] of pulseIds.entries()) if (exp <= now) pulseIds.delete(id);
  }

  function currentEventName(eventId) {
    const evt = settings.events?.find(e => e.id === eventId);
    return evt?.name || "Event";
  }

  function getRatingKey(game, first, last) {
    return `${String(game).trim()}|${String(first).trim().toLowerCase()}|${String(last).trim().toLowerCase()}`;
  }

  function getRatingDisplay(s) {
    const key = getRatingKey(s.game, s.first, s.last);
    const rating = ratings[key];
    if (!rating) return "—";
    const delta = rating.lastChange;
    const sign = delta > 0 ? "+" : "";
    return `${rating.rating} (${sign}${delta})`;
  }

  function passesFiltersCommon(item) {
    const qq = q.value.trim().toLowerCase();
    const ev = eventSel.value; // "" = all events
    const tf = trackFilter.value.trim().toLowerCase();

    if (activeGame && item.game !== activeGame) return false;
    if (ev && item.eventId !== ev) return false;
    if (tf && !String(item.track || "").toLowerCase().includes(tf)) return false;

    if (qq) {
      const hay = `${item.first} ${item.last} ${item.track} ${item.car} ${item.game} ${item.course} ${item.cohort} ${item.eventName}`.toLowerCase();
      if (!hay.includes(qq)) return false;
    }
    return true;
  }

  function updateStats(list) {
    statTotal.textContent = list.length;
    if (!list.length) {
      statDriver.textContent = "—";
      statTime.textContent = "—";
      return;
    }
    statDriver.textContent = `${list[0].first} ${list[0].last}`;
    statTime.textContent = `Best: ${list[0].time} • ${list[0].track}`;
  }

  function renderLeaderboard() {
    cleanupPulse();

    let list = scores.filter(passesFiltersCommon);
    list.sort((a,b) => timeToMs(a.time) - timeToMs(b.time));

    const view = list.slice(0, 40);

    lbRows.innerHTML = view.map((s, i) => {
      const rank = i + 1;
      const pulse = pulseIds.has(s.id) ? "pulse-new" : "";
      return `
        <tr class="${pulse} hover:bg-slate-950/30">
          <td class="px-5 py-4 text-slate-300 font-semibold">${rank}</td>
          <td class="px-5 py-4 text-white font-medium">${escapeHtml(`${s.first} ${s.last}`)}</td>
          <td class="px-5 py-4 text-sky-300 font-semibold">${escapeHtml(getRatingDisplay(s))}</td>
          <td class="px-5 py-4 text-white font-extrabold t-time tracking-tight">${escapeHtml(s.time)}</td>
          <td class="px-5 py-4 text-slate-200">${escapeHtml(s.game)}</td>
          <td class="px-5 py-4 text-slate-100">${escapeHtml(s.track)}</td>
          <td class="px-5 py-4 text-slate-300">${escapeHtml(s.car || "—")}</td>
          <td class="px-5 py-4 text-slate-300">${escapeHtml(s.eventName || currentEventName(s.eventId))}</td>
        </tr>
      `;
    }).join("");

    lbCount.textContent = `${list.length} entries (showing ${view.length})`;
    updateStats(list);
  }

  function renderAttempts() {
    let list = attempts.filter(passesFiltersCommon);
    list.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

    const view = list.slice(0, 300);

    attRows.innerHTML = view.map((a) => {
      const when = new Date(a.createdAt).toLocaleString("en-GB", { year:"2-digit", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      return `
        <tr class="hover:bg-slate-950/30">
          <td class="px-5 py-4 text-slate-300">${escapeHtml(when)}</td>
          <td class="px-5 py-4 text-white font-medium">${escapeHtml(`${a.first} ${a.last}`)}</td>
          <td class="px-5 py-4 text-white font-extrabold t-time tracking-tight">${escapeHtml(a.time)}</td>
          <td class="px-5 py-4 text-slate-200">${escapeHtml(a.game)}</td>
          <td class="px-5 py-4 text-slate-100">${escapeHtml(a.track)}</td>
          <td class="px-5 py-4 text-slate-300">${escapeHtml(a.car || "—")}</td>
          <td class="px-5 py-4 text-slate-300">${escapeHtml(a.eventName || currentEventName(a.eventId))}</td>
        </tr>
      `;
    }).join("");

    attCount.textContent = `${list.length} laps (showing ${view.length})`;
  }

  function render() {
    if (activeView === "leaderboard") renderLeaderboard();
    else renderAttempts();
  }

  async function fetchAttemptsInitial() {
    const res = await fetch("/api/attempts?limit=1500");
    attempts = await res.json();
    render();
  }

  // Socket events
  socket.on("loadScores", (existing) => {
    scores = Array.isArray(existing) ? existing : [];
    render();
  });

  socket.on("ratingsUpdate", (r) => {
    ratings = r || {};
    render();
  });

  socket.on("settingsUpdate", (s) => {
    settings = s || settings;

    const live = settings.events?.find(e => e.isLive);
    liveEventName.textContent = live?.name || "—";

    const current = eventSel.value || "";
    eventSel.innerHTML = `<option value="">All Events</option>` + (settings.events || []).map(e =>
      `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}${e.isLive ? " (LIVE)" : ""}</option>`
    ).join("");
    eventSel.value = (settings.events || []).some(e => e.id === current) ? current : "";

    render();
  });

  socket.on("scoreUpdate", (row) => {
    scores.push(row);
    pulseIds.set(row.id, Date.now() + 1400);
    render();
  });

  socket.on("scoreReplace", (row) => {
    const idx = scores.findIndex(s => s.id === row.id);
    if (idx !== -1) scores[idx] = row; else scores.push(row);
    pulseIds.set(row.id, Date.now() + 1400);
    render();
  });

  socket.on("attemptAdded", (att) => {
    attempts.push(att);
    if (attempts.length > 3000) attempts.splice(0, attempts.length - 3000);
    if (activeView === "attempts") renderAttempts();
  });

  socket.on("clearEvent", ({ eventId }) => {
    scores = scores.filter(s => s.eventId !== eventId);
    attempts = attempts.filter(a => a.eventId !== eventId);
    render();
  });

  socket.on("clearAll", () => {
    scores = [];
    attempts = [];
    render();
  });

  setActiveGame("");
  setView("leaderboard");
  fetchAttemptsInitial();
</script>
</body>
</html>
