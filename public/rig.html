<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rig Session — Leaderboard</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-zinc-950 text-zinc-100">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-2xl font-extrabold mb-4">Rig Session — Assetto Corsa</h1>

    <div id="statusRow" class="flex items-center gap-3 mb-4">
      <div id="liveEvent" class="text-sm text-zinc-300" aria-live="polite">LIVE event: —</div>
      <div id="rigStatus" class="ml-auto text-sm px-3 py-1 rounded-full bg-amber-500/10 border border-amber-500 text-amber-300" role="status">Rig: ready</div>
    </div>

    <!-- Driver setup -->
    <section id="setup" class="rounded-xl border border-zinc-800 bg-zinc-900/60 p-4 mb-4" aria-labelledby="setupTitle">
      <h2 id="setupTitle" class="font-semibold mb-2">Driver Setup</h2>

      <div class="grid grid-cols-2 gap-2 mb-2">
        <input id="first" placeholder="First name" aria-label="First name" class="bg-zinc-950 border border-zinc-800 rounded-xl px-3 py-2" />
        <input id="last" placeholder="Last name" aria-label="Last name" class="bg-zinc-950 border border-zinc-800 rounded-xl px-3 py-2" />
      </div>

      <div class="grid grid-cols-2 gap-2 mb-2">
        <select id="cohort" aria-label="Cohort" class="bg-zinc-950 border border-zinc-800 rounded-xl px-3 py-2">
          <option>Guest</option>
          <option>Staff</option>
          <option>Y1</option>
          <option>Y2</option>
          <option>Y3</option>
        </select>
        <input id="course" placeholder="Course (Games / Computing...)" aria-label="Course" class="bg-zinc-950 border border-zinc-800 rounded-xl px-3 py-2" />
      </div>

      <div class="grid grid-cols-2 gap-2 mb-2">
        <input id="car" placeholder="Car (optional)" aria-label="Car" class="bg-zinc-950 border border-zinc-800 rounded-xl px-3 py-2" />
        <input id="track" placeholder="Track name" aria-label="Track" class="bg-zinc-950 border border-zinc-800 rounded-xl px-3 py-2" />
      </div>

      <div class="grid grid-cols-2 gap-2 mb-2">
        <input id="rigKey" placeholder="Rig Key (stored locally)" aria-label="Rig Key" class="bg-zinc-950 border border-zinc-800 rounded-xl px-3 py-2" />
        <input id="serverBase" placeholder="Server base URL (leave blank for same host)" aria-label="Server base URL" class="bg-zinc-950 border border-zinc-800 rounded-xl px-3 py-2" />
      </div>

      <div class="flex gap-2 mt-3">
        <button id="saveDriver" class="px-4 py-2 rounded-xl bg-white text-black font-semibold">Save & Start Session</button>
        <button id="resetDriver" class="px-4 py-2 rounded-xl border border-zinc-800">Reset</button>
      </div>
      <p class="text-xs text-zinc-500 mt-2">Saved locally — refresh the page to resume session.</p>
    </section>

    <!-- Session view -->
    <section id="session" class="hidden rounded-xl border border-zinc-800 bg-zinc-900/60 p-4" aria-live="polite">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div id="driverName" class="text-lg font-semibold">—</div>
          <div id="driverMeta" class="text-sm text-zinc-400">—</div>
        </div>
        <div class="text-right">
          <div id="sessionProgress" class="text-sm">Out lap 0/0</div>
          <div id="lastLap" class="text-2xl font-extrabold mt-2">—</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mb-3">
        <div class="rounded-xl border border-zinc-800 p-3">
          <div class="text-xs text-zinc-400">Session mode</div>
          <div id="sessionMode" class="font-semibold">Armed</div>
          <div class="text-xs text-zinc-500 mt-2">Out laps ignored, then timed laps submitted automatically.</div>
        </div>

        <div class="rounded-xl border border-zinc-800 p-3">
          <div class="text-xs text-zinc-400">Network</div>
          <div id="netIndicator" class="font-semibold text-green-400">Online</div>
          <div id="queuedCount" class="text-xs text-zinc-500 mt-2" aria-live="polite">Queued: 0</div>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="lapBtn" class="flex-1 px-4 py-4 rounded-xl bg-amber-500 text-black font-extrabold text-xl" aria-label="Simulate lap (L)">Lap (simulate)</button>
        <button id="stopBtn" class="px-4 py-4 rounded-xl bg-red-600 text-white font-semibold">Stop</button>
        <button id="resetSessionBtn" class="px-4 py-4 rounded-xl border border-zinc-800">Reset</button>
      </div>

      <div id="sessionLog" class="mt-3 text-xs text-zinc-400 max-h-48 overflow-auto" aria-live="polite"></div>
    </section>
  </div>

<script>
(function () {
  const LS_DRIVER = "rig_driver";
  const LS_SESSION = "rig_session";
  const LS_QUEUED = "rig_queued";

  const liveEventEl = document.getElementById("liveEvent");
  const rigStatus = document.getElementById("rigStatus");
  const saveDriverBtn = document.getElementById("saveDriver");
  const resetDriverBtn = document.getElementById("resetDriver");
  const setupDiv = document.getElementById("setup");
  const sessionDiv = document.getElementById("session");
  const driverNameEl = document.getElementById("driverName");
  const driverMetaEl = document.getElementById("driverMeta");
  const sessionProgress = document.getElementById("sessionProgress");
  const lastLapEl = document.getElementById("lastLap");
  const lapBtn = document.getElementById("lapBtn");
  const stopBtn = document.getElementById("stopBtn");
  const resetSessionBtn = document.getElementById("resetSessionBtn");
  const netIndicator = document.getElementById("netIndicator");
  const queuedCount = document.getElementById("queuedCount");
  const sessionLog = document.getElementById("sessionLog");
  const sessionMode = document.getElementById("sessionMode");

  const firstEl = document.getElementById("first");
  const lastEl = document.getElementById("last");
  const courseEl = document.getElementById("course");
  const cohortEl = document.getElementById("cohort");
  const rigKeyEl = document.getElementById("rigKey");
  const serverBaseEl = document.getElementById("serverBase");
  const trackEl = document.getElementById("track");
  const carEl = document.getElementById("car");

  // Focus first field for quick entry
  firstEl.focus();

  function loadDriver() { try { return JSON.parse(localStorage.getItem(LS_DRIVER) || 'null'); } catch(e){return null;} }
  function saveDriver(obj) { localStorage.setItem(LS_DRIVER, JSON.stringify(obj)); }
  function clearDriver() { localStorage.removeItem(LS_DRIVER); }

  function loadSession() { try { return JSON.parse(localStorage.getItem(LS_SESSION) || 'null'); } catch(e){return null;} }
  function saveSession(obj) { localStorage.setItem(LS_SESSION, JSON.stringify(obj)); }
  function clearSession() { localStorage.removeItem(LS_SESSION); }

  function loadQueued() { try { return JSON.parse(localStorage.getItem(LS_QUEUED) || '[]'); } catch(e){return [];} }
  function saveQueued(arr) { localStorage.setItem(LS_QUEUED, JSON.stringify(arr)); }
  function pushQueued(obj) { const arr = loadQueued(); arr.push(obj); while(arr.length>2000) arr.shift(); saveQueued(arr); updateQueuedUI(); }

  function updateQueuedUI(){ const q=loadQueued(); queuedCount.textContent = `Queued: ${q.length}`; queuedCount.style.color = q.length ? "#f59e0b" : "#94a3b8"; }

  function logLine(s){ const t=`[${new Date().toLocaleTimeString()}] ${s}`; const d=document.createElement('div'); d.textContent=t; sessionLog.prepend(d); }

  async function getRigState(base){ try{ const url=(base||'') + '/api/rig/state'; const r=await fetch(url); if(!r.ok) return null; return await r.json(); }catch(e){return null;} }
  async function refreshLiveEvent(){ const state = await getRigState(serverBaseEl.value); if(state?.liveEventName) liveEventEl.textContent = `LIVE event: ${state.liveEventName}`; }

  // network POST helper
  async function postLapToServer(base, key, payload){ try{ const url=(base||'') + '/api/submit-lap'; const r = await fetch(url, { method:'POST', headers: { 'Content-Type':'application/json','X-Rig-Key': key }, body: JSON.stringify(payload) }); if(!r.ok){ const txt = await r.text(); return { ok:false, status:r.status, text:txt }; } const j = await r.json(); return { ok:true, json:j }; }catch(e){ return { ok:false, err:String(e) }; } }

  async function flushQueued(){ const queued=loadQueued(); if(!queued.length){ netIndicator.textContent='Online'; netIndicator.style.color='#22c55e'; return; } const key = rigKeyEl.value.trim(); const base = serverBaseEl.value.trim(); let flushed=0; for(let i=0;i<queued.length;i++){ const item=queued[i]; const r=await postLapToServer(base,key,item); if(r.ok && r.json?.ok){ queued.shift(); flushed++; } else { break; } } if(flushed){ saveQueued(queued); logLine(`Flushed ${flushed} queued laps`); } updateQueuedUI(); }

  async function handleLap(timeStr){ const d = loadDriver(); if(!d){ logLine('No driver set - ignoring lap'); return; } const state = await getRigState(serverBaseEl.value); const cfg = state?.rig || { outLaps:1, timedLaps:3 }; let s = loadSession(); if(!s){ s = { startedAt: new Date().toISOString(), outCount:0, timedCount:0, lastLapTime:null, finished:false }; }
    if(s.outCount < Number(cfg.outLaps || 1)){ s.outCount++; s.lastLapTime = timeStr; saveSession(s); renderSession(); logLine(`Out lap ${s.outCount}/${cfg.outLaps} ignored`); return; }
    if(s.timedCount >= Number(cfg.timedLaps || 3)){ s.finished = true; saveSession(s); renderSession(); logLine('Session already finished'); return; }

    const payload = { first: d.first, last: d.last, time: timeStr, day: new Date().toLocaleDateString('en-GB',{weekday:'short'}), game: 'Assetto Corsa', car: d.car||'', track: d.track||'', cohort: d.cohort||'Guest', course: d.course||'—', createdAt: new Date().toISOString() };
    const key = rigKeyEl.value.trim(); const base = serverBaseEl.value.trim(); const r = await postLapToServer(base,key,payload);
    if(r.ok && r.json?.ok){ s.timedCount++; s.lastLapTime=timeStr; if(s.timedCount>= (cfg.timedLaps||3)) s.finished=true; saveSession(s); renderSession(); logLine(`Timed lap submitted (${r.json.mode})`); await flushQueued(); netIndicator.textContent='Online'; netIndicator.style.color='#22c55e'; return; }
    // else queue
    pushQueued(payload); s.timedCount++; s.lastLapTime=timeStr; if(s.timedCount>= (cfg.timedLaps||3)) s.finished=true; saveSession(s); renderSession(); logLine('Network failure, queued offline'); netIndicator.textContent='Offline (queued)'; netIndicator.style.color='#f59e0b'; }

  lapBtn.addEventListener('click', async ()=>{ const t = prompt('Enter lap time (m:ss.mmm or s.mmm)','1:23.456'); if(!t) return; await handleLap(t.trim()); });
  stopBtn.addEventListener('click', ()=>{ const s = loadSession(); if(s){ s.finished=true; saveSession(s); renderSession(); logLine('Session stopped by operator'); } });
  resetSessionBtn.addEventListener('click', ()=>{ const ok = confirm('Reset session and queued laps?'); if(!ok) return; clearSession(); saveQueued([]); updateQueuedUI(); sessionLog.innerHTML=''; closeSession(); logLine('Session reset'); });

  saveDriverBtn.addEventListener('click', async ()=>{ const first = firstEl.value.trim(); const last = lastEl.value.trim(); if(!first || !last){ alert('Type first and last name'); return; } const d = { first, last, course: courseEl.value.trim()||'—', cohort: cohortEl.value||'Guest', car: carEl.value.trim()||'', track: trackEl.value.trim()||'', rigKey: rigKeyEl.value.trim(), serverBase: serverBaseEl.value.trim() }; saveDriver(d); clearSession(); await refreshLiveEvent(); openSession(); const state = await getRigState(serverBaseEl.value); const cfg = state?.rig || { outLaps:1, timedLaps:3 }; const s = { startedAt: new Date().toISOString(), outCount:0, timedCount:0, lastLapTime:null, finished:false, outTotal:cfg.outLaps, timedTotal:cfg.timedLaps }; saveSession(s); renderSession(); updateQueuedUI(); logLine('Session started'); });

  resetDriverBtn.addEventListener('click', ()=>{ const ok = confirm('Clear saved driver info?'); if(!ok) return; clearDriver(); clearSession(); saveQueued([]); updateQueuedUI(); location.reload(); });

  [firstEl,lastEl,courseEl,cohortEl,rigKeyEl,serverBaseEl,trackEl,carEl].forEach(inp=>{ inp.addEventListener('change', ()=>{ const cur = loadDriver()||{}; cur.first = firstEl.value.trim(); cur.last = lastEl.value.trim(); cur.course = courseEl.value.trim(); cur.cohort = cohortEl.value; cur.rigKey = rigKeyEl.value.trim(); cur.serverBase = serverBaseEl.value.trim(); cur.track = trackEl.value.trim(); cur.car = carEl.value.trim(); saveDriver(cur); }); });

  // keyboard shortcut: press 'L' to trigger lap simulate (for quick testing)
  document.addEventListener('keydown',(e)=>{ if(e.key==='l' || e.key==='L'){ lapBtn.focus(); lapBtn.click(); } });

  // session UI helpers
  function openSession(){ setupDiv.classList.add('hidden'); sessionDiv.classList.remove('hidden'); rigStatus.textContent='Rig: armed'; rigStatus.className='ml-auto text-sm px-3 py-1 rounded-full bg-amber-500/10 border border-amber-500 text-amber-300'; }
  function closeSession(){ setupDiv.classList.remove('hidden'); sessionDiv.classList.add('hidden'); rigStatus.textContent='Rig: ready'; rigStatus.className='ml-auto text-sm px-3 py-1 rounded-full bg-amber-500/10 border border-amber-500 text-amber-300'; }
  function renderSession(){ const d = loadDriver(); const s = loadSession(); const cfg = (async()=>{ const st = await getRigState(serverBaseEl.value); return st?.rig || { outLaps:1, timedLaps:3 }; })(); Promise.resolve(cfg).then(cfg=>{ driverNameEl.textContent = `${d.first} ${d.last}`; driverMetaEl.textContent = `${d.cohort} • ${d.course} • ${d.track||'—'} • ${d.car||'—'}`; sessionProgress.textContent = `Out lap ${s.outCount}/${cfg.outLaps} • Timed ${s.timedCount}/${cfg.timedLaps}`; sessionMode.textContent = s.finished ? 'Finished' : 'Running'; lastLapEl.textContent = s.lastLapTime || '—'; }); }

  // periodic flush
  setInterval(async ()=>{ await flushQueued(); }, 10000);

  // initial restore
  (async ()=>{ const d = loadDriver(); const s = loadSession(); if(d){ firstEl.value=d.first||''; lastEl.value=d.last||''; courseEl.value=d.course||''; cohortEl.value=d.cohort||'Guest'; rigKeyEl.value=d.rigKey||''; serverBaseEl.value=d.serverBase||''; trackEl.value=d.track||''; carEl.value=d.car||''; }
    if(s && s.startedAt && !s.finished){ openSession(); renderSession(); } updateQueuedUI(); await refreshLiveEvent(); })();
})();
</script>
</body>
</html>
