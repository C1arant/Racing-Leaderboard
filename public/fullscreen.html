<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fullscreen Leaderboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root{
      --pad: clamp(12px, 1.4vmin, 28px);
      --title: clamp(24px, 3vw, 64px);
      --sub: clamp(12px, 1.15vw, 20px);
      --driver: clamp(18px, 1.45vw, 28px);
      --time: clamp(22px, 2.1vw, 48px);
      --table: clamp(13px, 1.1vw, 20px);
      --rank: clamp(14px, 1.2vw, 24px);
      --rowPadY: clamp(10px, 1.2vmin, 18px);
    }
    .t-title{ font-size: var(--title); }
    .t-sub{ font-size: var(--sub); }
    .t-driver{ font-size: var(--driver); }
    .t-time{ font-size: var(--time); }
    .t-table{ font-size: var(--table); }
    .t-rank{ font-size: var(--rank); }

    body { cursor: none; }
    * { user-select: none; -webkit-user-select: none; }

    .pulse-new { animation: pulseNew 1.15s ease-out 1; }
    @keyframes pulseNew {
      0%   { box-shadow: 0 0 0 0 rgba(16,185,129,0.26); background-color: rgba(16,185,129,0.06); }
      60%  { box-shadow: 0 0 0 26px rgba(16,185,129,0.00); }
      100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.00); background-color: transparent; }
    }
  </style>
</head>

<body class="min-h-screen bg-black text-white">
  <div class="h-screen w-screen p-[var(--pad)] flex flex-col gap-[var(--pad)]">
    <header class="flex items-end justify-between gap-4">
      <div class="min-w-0">
        <p class="t-sub uppercase tracking-[0.4em] text-emerald-400">Live Time Trial</p>
        <div class="flex items-center gap-3 min-w-0">
          <h1 class="t-title font-black tracking-tight truncate">Event Leaderboard</h1>
          <span class="t-sub inline-flex items-center gap-2 bg-black/80 border border-emerald-500/20 rounded-full px-4 py-2 text-emerald-100">
            <span id="eventName" class="font-semibold truncate">â€”</span>
          </span>
        </div>
        <p class="t-sub text-emerald-200/70 mt-2">Top 20 with Driver Rating (DR) deltas. Auto-updating.</p>
      </div>

      <div class="flex items-center gap-3 t-sub">
        <span class="inline-flex items-center gap-2 bg-black/80 border border-emerald-500/20 rounded-full px-4 py-2">
          <span id="liveDot" class="w-2.5 h-2.5 rounded-full bg-emerald-500" aria-hidden="true"></span>
          <span id="liveLabel">Live</span>
        </span>
        <a href="/" class="ml-3 text-sm px-3 py-2 rounded-md bg-black/80 border border-emerald-500/20 text-emerald-100 hover:bg-black">Back to display</a>
      </div>
    </header>

    <div class="flex-1 grid grid-cols-12 gap-[var(--pad)] min-h-0">
      <section class="col-span-12 lg:col-span-4 flex flex-col gap-[var(--pad)]">
        <div class="rounded-[22px] border border-amber-500/35 bg-gradient-to-br from-amber-500/15 to-transparent p-[var(--pad)]">
          <div class="flex items-center justify-between">
            <div class="t-sub font-semibold">ðŸ¥‡ P1</div>
            <div class="t-sub text-emerald-200/70" id="p1_meta">â€”</div>
          </div>
          <div class="mt-3">
            <div class="t-driver font-semibold truncate" id="p1_driver">â€”</div>
            <div class="t-time font-extrabold tracking-tight" id="p1_time">â€”</div>
            <div class="t-sub text-emerald-200/70 mt-2 truncate" id="p1_detail">â€”</div>
          </div>
        </div>

        <div class="rounded-[22px] border border-emerald-500/25 bg-gradient-to-br from-emerald-500/10 to-transparent p-[var(--pad)]">
          <div class="flex items-center justify-between">
            <div class="t-sub font-semibold">ðŸ¥ˆ P2</div>
            <div class="t-sub text-emerald-200/70" id="p2_meta">â€”</div>
          </div>
          <div class="mt-3">
            <div class="t-driver font-semibold truncate" id="p2_driver">â€”</div>
            <div class="t-time font-extrabold tracking-tight" id="p2_time">â€”</div>
            <div class="t-sub text-emerald-200/70 mt-2 truncate" id="p2_detail">â€”</div>
          </div>
        </div>

        <div class="rounded-[22px] border border-orange-300/25 bg-gradient-to-br from-orange-500/12 to-transparent p-[var(--pad)]">
          <div class="flex items-center justify-between">
            <div class="t-sub font-semibold">ðŸ¥‰ P3</div>
            <div class="t-sub text-emerald-200/70" id="p3_meta">â€”</div>
          </div>
          <div class="mt-3">
            <div class="t-driver font-semibold truncate" id="p3_driver">â€”</div>
            <div class="t-time font-extrabold tracking-tight" id="p3_time">â€”</div>
            <div class="t-sub text-emerald-200/70 mt-2 truncate" id="p3_detail">â€”</div>
          </div>
        </div>
      </section>

      <section class="col-span-12 lg:col-span-8 flex flex-col min-h-0">
        <div class="rounded-[22px] border border-emerald-500/20 bg-black/80 overflow-hidden flex flex-col min-h-0">
          <div class="px-[var(--pad)] py-[calc(var(--pad)*0.75)] bg-black/55 flex items-center justify-between">
            <div class="t-table font-semibold">Top 20</div>
            <div class="t-sub text-emerald-200/70"><span id="count">0 entries</span></div>
          </div>

          <div class="flex-1 min-h-0 overflow-hidden">
            <table class="w-full">
              <thead class="bg-black/45 text-emerald-200/70 t-sub">
                <tr>
                  <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] w-[6rem]">#</th>
                  <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)]">Driver</th>
                <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] w-[14rem]">Driver Rating (DR)</th>
                <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] w-[14rem]">Time</th>
                <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)]">Track</th>
                  <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] hidden lg:table-cell">Car</th>
                  <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] w-[18rem] hidden xl:table-cell">Tag</th>
                </tr>
              </thead>
              <tbody id="rows" class="divide-y divide-emerald-500/20 t-table"></tbody>
            </table>
          </div>

          <div class="px-[var(--pad)] py-[calc(var(--pad)*0.6)] bg-black/40 t-sub text-emerald-200/70 flex justify-between">
            <span>Auto-updating</span>
            <span id="footerNote">Pinned display</span>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
  const socket = io();

  const rows = document.getElementById("rows");
  const count = document.getElementById("count");

  const eventNameEl = document.getElementById("eventName");

  const liveLabel = document.getElementById("liveLabel");
  const liveDot = document.getElementById("liveDot");

  const P = {
    p1_driver: document.getElementById("p1_driver"),
    p1_time: document.getElementById("p1_time"),
    p1_detail: document.getElementById("p1_detail"),
    p1_meta: document.getElementById("p1_meta"),
    p2_driver: document.getElementById("p2_driver"),
    p2_time: document.getElementById("p2_time"),
    p2_detail: document.getElementById("p2_detail"),
    p2_meta: document.getElementById("p2_meta"),
    p3_driver: document.getElementById("p3_driver"),
    p3_time: document.getElementById("p3_time"),
    p3_detail: document.getElementById("p3_detail"),
    p3_meta: document.getElementById("p3_meta"),
  };

  let scores = [];
  let settings = { events: [], fullscreen: { eventId: "", game: "" } };
  let ratings = {};
  let pulseIds = new Map();

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function timeToMs(t) {
    const str = String(t).trim();
    if (/^\d+:\d{2}\.\d{3}$/.test(str)) {
      const [m, rest] = str.split(":");
      const [s, ms] = rest.split(".");
      return (parseInt(m,10) * 60 + parseInt(s,10)) * 1000 + parseInt(ms,10);
    }
    if (/^\d+\.\d{3}$/.test(str)) {
      const [s, ms] = str.split(".");
      return parseInt(s,10) * 1000 + parseInt(ms,10);
    }
    return Infinity;
  }

  function cleanupPulse() {
    const now = Date.now();
    for (const [id, exp] of pulseIds.entries()) if (exp <= now) pulseIds.delete(id);
  }

  function getRatingKey(game, first, last) {
    return `${String(game).trim()}|${String(first).trim().toLowerCase()}|${String(last).trim().toLowerCase()}`;
  }

  function getRatingDisplay(s) {
    const key = getRatingKey(s.game, s.first, s.last);
    const rating = ratings[key];
    if (!rating) return "â€”";
    const delta = rating.lastChange;
    const sign = delta > 0 ? "+" : "";
    return `${rating.rating} (${sign}${delta})`;
  }

  function setPodium(rank, s) {
    const id = rank === 1 ? "p1" : rank === 2 ? "p2" : "p3";
    if (!s) {
      P[`${id}_driver`].textContent = "â€”";
      P[`${id}_time`].textContent = "â€”";
      P[`${id}_detail`].textContent = "â€”";
      P[`${id}_meta`].textContent = "â€”";
      return;
    }
    P[`${id}_driver`].textContent = `${s.first} ${s.last}`.trim();
    P[`${id}_time`].textContent = s.time || "â€”";
    P[`${id}_detail`].textContent = `${s.game} â€¢ ${s.track} â€¢ ${s.car || "â€”"}`;
    P[`${id}_meta`].textContent = `${s.cohort || "Guest"} â€¢ ${s.course || "â€”"}`;
  }

  function render() {
    cleanupPulse();

    const liveEvent = settings.fullscreen?.eventId || settings.liveEventId;
    const eventName = settings.events?.find(e => e.id === liveEvent)?.name || "â€”";
    eventNameEl.textContent = eventName;

    let list = scores.filter(s => s.eventId === liveEvent);

    list.sort((a,b) => timeToMs(a.time) - timeToMs(b.time));

    setPodium(1, list[0]);
    setPodium(2, list[1]);
    setPodium(3, list[2]);

    const view = list.slice(0, 20);

    rows.innerHTML = view.map((s, i) => {
      const pulse = pulseIds.has(s.id) ? "pulse-new" : "";
      return `
        <tr class="${pulse} hover:bg-black/30">
          <td class="px-[var(--pad)] py-[var(--rowPadY)] t-rank text-emerald-200/70 font-semibold">${i + 1}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] font-semibold text-white">${escapeHtml(`${s.first} ${s.last}`)}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] text-sky-300 font-semibold">${escapeHtml(getRatingDisplay(s))}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] t-time font-extrabold text-white">${escapeHtml(s.time)}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)]">${escapeHtml(s.track)}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] hidden lg:table-cell">${escapeHtml(s.car || "â€”")}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] hidden xl:table-cell text-emerald-200/70">${escapeHtml(`${s.cohort || "Guest"} â€¢ ${s.course || "â€”"}`)}</td>
        </tr>
      `;
    }).join("");

    count.textContent = `${list.length} entries`;
  }

  socket.on("loadScores", (existing) => {
    scores = Array.isArray(existing) ? existing : [];
    render();
  });

  socket.on("settingsUpdate", (s) => {
    settings = s || settings;
    const followLive = settings.fullscreen?.followLiveEvent;
    liveLabel.textContent = followLive ? "Live" : "Pinned";
    liveDot.className = followLive ? "w-2.5 h-2.5 rounded-full bg-emerald-500" : "w-2.5 h-2.5 rounded-full bg-amber-500";
    render();
  });

  socket.on("ratingsUpdate", (r) => {
    ratings = r || {};
    render();
  });

  socket.on("scoreUpdate", (row) => {
    scores.push(row);
    pulseIds.set(row.id, Date.now() + 1400);
    render();
  });

  socket.on("scoreReplace", (row) => {
    const idx = scores.findIndex(s => s.id === row.id);
    if (idx !== -1) scores[idx] = row; else scores.push(row);
    pulseIds.set(row.id, Date.now() + 1400);
    render();
  });

  socket.on("deleteScore", ({ id }) => {
    scores = scores.filter(s => s.id !== id);
    render();
  });

  socket.on("clearEvent", ({ eventId }) => {
    scores = scores.filter(s => s.eventId !== eventId);
    render();
  });

  socket.on("clearAll", () => {
    scores = [];
    render();
  });
</script>
</body>
</html>
