<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fullscreen Leaderboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root{
      --pad: clamp(12px, 1.4vmin, 28px);
      --title: clamp(24px, 3vw, 64px);
      --sub: clamp(12px, 1.15vw, 20px);
      --driver: clamp(18px, 1.45vw, 28px);
      --time: clamp(22px, 2.1vw, 48px);
      --table: clamp(13px, 1.1vw, 20px);
      --rank: clamp(14px, 1.2vw, 24px);
      --rowPadY: clamp(10px, 1.2vmin, 18px);
    }
    .t-title{ font-size: var(--title); }
    .t-sub{ font-size: var(--sub); }
    .t-driver{ font-size: var(--driver); }
    .t-time{ font-size: var(--time); }
    .t-table{ font-size: var(--table); }
    .t-rank{ font-size: var(--rank); }

    body { cursor: none; }
    * { user-select: none; -webkit-user-select: none; }

    .pulse-new { animation: pulseNew 1.15s ease-out 1; }
    @keyframes pulseNew {
      0%   { box-shadow: 0 0 0 0 rgba(239,68,68,0.24); background-color: rgba(239,68,68,0.08); }
      60%  { box-shadow: 0 0 0 26px rgba(239,68,68,0.00); }
      100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.00); background-color: transparent; }
    }

    /* broadcast polish */
    .panel { backdrop-filter: blur(10px); }
    .soft-scroll::-webkit-scrollbar { width: 12px; height: 12px; }
    .soft-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,.10); border-radius: 999px; }
    .soft-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,.03); border-radius: 999px; }

    .tabular { font-variant-numeric: tabular-nums; }
  </style>
</head>

<body class="min-h-screen bg-zinc-950 text-zinc-100">
  <!-- subtle glow so it feels ‚Äúlive‚Äù -->
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute -top-56 left-1/2 h-[560px] w-[980px] -translate-x-1/2 rounded-full bg-emerald-500/10 blur-3xl"></div>
    <div class="absolute -bottom-64 right-[-140px] h-[600px] w-[840px] rounded-full bg-amber-500/10 blur-3xl"></div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_top,rgba(255,255,255,.05),transparent_55%)]"></div>
  </div>

  <div class="h-screen w-screen p-[var(--pad)] flex flex-col gap-[var(--pad)]">
    <!-- Banner -->
    <div class="panel rounded-[24px] border border-zinc-800/80 bg-zinc-900/40 px-[var(--pad)] py-[calc(var(--pad)*0.75)] flex items-end justify-between gap-4 shadow-[0_0_0_1px_rgba(255,255,255,.03)]">
      <div class="min-w-0">
        <p class="t-sub uppercase tracking-[0.4em] text-red-500">Live Time Trial</p>
        <div class="flex items-center gap-3 min-w-0">
          <h1 class="t-title font-extrabold tracking-tight truncate">üèÅ ESCG Laps</h1>

          <span class="t-sub inline-flex items-center gap-2 border border-emerald-500/35 bg-emerald-500/10 rounded-full px-4 py-2 text-emerald-100">
            <span class="inline-flex h-2.5 w-2.5 rounded-full bg-emerald-400 animate-pulse"></span>
            <span id="eventName" class="font-semibold truncate">‚Äî</span>
          </span>

          <span class="t-sub inline-flex items-center gap-2 bg-zinc-950/50 border border-zinc-800 rounded-full px-4 py-2 text-zinc-200">
            View: <span id="gameLabel" class="font-semibold">Mixed</span>
          </span>
        </div>
        
      </div>

      <div class="flex items-center gap-3 t-sub">
        <span class="inline-flex items-center gap-2 bg-zinc-950/50 border border-zinc-800 rounded-full px-4 py-2">
          <span id="liveDot" class="w-2.5 h-2.5 rounded-full bg-emerald-500" aria-hidden="true"></span>
          <span id="liveLabel">Live</span>
        </span>
        <a href="/" class="ml-3 text-sm px-3 py-2 rounded-xl bg-zinc-950/50 border border-zinc-800 text-zinc-200 hover:bg-zinc-900">
          Back to display
        </a>
      </div>
    </header>

    <!-- Podium -->
    <div class="w-full flex justify-center">
      <div class="w-full max-w-[1900px] grid grid-cols-12 gap-[var(--pad)]">
        <!-- P2 -->
        <div class="col-span-12 md:col-span-4 order-2 md:order-1">
          <div class="panel h-full rounded-[26px] border border-zinc-200/25 bg-gradient-to-r from-zinc-200/10 to-transparent p-[var(--pad)] shadow-[0_0_0_1px_rgba(255,255,255,.02)]">
            <div class="flex items-center justify-between">
              <div class="t-sub font-semibold">ü•à P2</div>
              <div class="t-sub text-zinc-300" id="p2_meta">‚Äî</div>
            </div>
            <div class="mt-3">
              <div class="t-driver font-semibold truncate" id="p2_driver">‚Äî</div>
              <div class="t-time font-extrabold tracking-tight tabular" id="p2_time">‚Äî</div>
              <div class="t-sub text-zinc-300 mt-2 truncate" id="p2_detail">‚Äî</div>
            </div>
          </div>
        </div>

        <!-- P1 -->
        <div class="col-span-12 md:col-span-4 order-1 md:order-2">
          <div class="panel h-full rounded-[26px] border border-amber-500/35 bg-gradient-to-r from-amber-500/18 to-transparent p-[var(--pad)] shadow-[0_0_0_1px_rgba(255,255,255,.02)]">
            <div class="flex items-center justify-between">
              <div class="t-sub font-semibold">ü•á P1</div>
              <div class="t-sub text-zinc-300" id="p1_meta">‚Äî</div>
            </div>
            <div class="mt-3">
              <div class="t-driver font-semibold truncate" id="p1_driver">‚Äî</div>
              <div class="t-time font-extrabold tracking-tight tabular" id="p1_time">‚Äî</div>
              <div class="t-sub text-zinc-300 mt-2 truncate" id="p1_detail">‚Äî</div>
            </div>
          </div>
        </div>

        <!-- P3 -->
        <div class="col-span-12 md:col-span-4 order-3">
          <div class="panel h-full rounded-[26px] border border-orange-300/25 bg-gradient-to-r from-orange-500/12 to-transparent p-[var(--pad)] shadow-[0_0_0_1px_rgba(255,255,255,.02)]">
            <div class="flex items-center justify-between">
              <div class="t-sub font-semibold">ü•â P3</div>
              <div class="t-sub text-zinc-300" id="p3_meta">‚Äî</div>
            </div>
            <div class="mt-3">
              <div class="t-driver font-semibold truncate" id="p3_driver">‚Äî</div>
              <div class="t-time font-extrabold tracking-tight tabular" id="p3_time">‚Äî</div>
              <div class="t-sub text-zinc-300 mt-2 truncate" id="p3_detail">‚Äî</div>
            </div>
          </div>
        </div>
      </section>

    <!-- Table -->
    <div class="flex-1 min-h-0 w-full flex justify-center">
      <div class="w-full max-w-[2200px] panel rounded-[26px] border border-zinc-800/80 bg-zinc-900/40 overflow-hidden flex flex-col shadow-[0_0_0_1px_rgba(255,255,255,.03)]">
        <div class="px-[var(--pad)] py-[calc(var(--pad)*0.75)] bg-zinc-950/55 flex items-center justify-between">
          <div class="t-table font-semibold">Top 20</div>
          <div class="t-sub text-zinc-400"><span id="count">0 entries</span></div>
        </div>

        <!-- FIX: actual scroll container for auto-scroll -->
        <div id="scrollWrap" class="flex-1 min-h-0 overflow-auto soft-scroll">
          <table class="w-full">
            <thead class="bg-zinc-950/45 text-zinc-300 t-sub sticky top-0">
              <tr>
                <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] w-[7rem]">#</th>
                <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)]">Driver</th>
                <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] w-[12rem]">Rating</th>
                <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] w-[16rem]">Time</th>
                <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] w-[14rem] hidden md:table-cell">Game</th>
                <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)]">Track</th>
                  <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] hidden lg:table-cell">Car</th>
                  <th class="text-left px-[var(--pad)] py-[calc(var(--pad)*0.6)] w-[18rem] hidden xl:table-cell">Cohort / Course</th>
                </tr>
              </thead>
              <tbody id="rows" class="divide-y divide-white/10 t-table"></tbody>
            </table>
          </div>

          <div class="px-[var(--pad)] py-[calc(var(--pad)*0.6)] bg-black/40 t-sub text-white/60 flex justify-between">
            <span>Auto-updating</span>
            <span id="footerNote">Pinned display</span>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
  const socket = io();

  const rows = document.getElementById("rows");
  const count = document.getElementById("count");

  const eventNameEl = document.getElementById("eventName");

  const liveLabel = document.getElementById("liveLabel");
  const liveDot = document.getElementById("liveDot");

  const scrollWrap = document.getElementById("scrollWrap");

  const P = {
    p1_driver: document.getElementById("p1_driver"),
    p1_time: document.getElementById("p1_time"),
    p1_detail: document.getElementById("p1_detail"),
    p1_meta: document.getElementById("p1_meta"),
    p2_driver: document.getElementById("p2_driver"),
    p2_time: document.getElementById("p2_time"),
    p2_detail: document.getElementById("p2_detail"),
    p2_meta: document.getElementById("p2_meta"),
    p3_driver: document.getElementById("p3_driver"),
    p3_time: document.getElementById("p3_time"),
    p3_detail: document.getElementById("p3_detail"),
    p3_meta: document.getElementById("p3_meta"),
  };

  let scores = [];
  let settings = { defaultTrack: "spa" };
  let ratings = {};
  let pulseIds = new Map();

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function timeToMs(t) {
    const str = String(t).trim();
    if (/^\d+:\d{2}\.\d{3}$/.test(str)) {
      const [m, rest] = str.split(":");
      const [s, ms] = rest.split(".");
      return (parseInt(m,10) * 60 + parseInt(s,10)) * 1000 + parseInt(ms,10);
    }
    if (/^\d+\.\d{3}$/.test(str)) {
      const [s, ms] = str.split(".");
      return parseInt(s,10) * 1000 + parseInt(ms,10);
    }
    return Infinity;
  }

  function cleanupPulse() {
    const now = Date.now();
    for (const [id, exp] of pulseIds.entries()) if (exp <= now) pulseIds.delete(id);
  }

  function getRatingKey(game, first, last) {
    return `${String(game).trim()}|${String(first).trim().toLowerCase()}|${String(last).trim().toLowerCase()}`;
  }

  function getRatingDisplay(s) {
    const key = getRatingKey(s.game, s.first, s.last);
    const rating = ratings[key];
    if (!rating) return "‚Äî ";
    const dir = rating.lastChange > 0 ? "‚Üë" : rating.lastChange < 0 ? "‚Üì" : "";
    return `${rating.rating} ${dir}${Math.abs(rating.lastChange)}`.trim();
  }

  function normalizeName(first, last, cohort) {
    const nameMode = settings.privacy?.nameMode || "FULL";
    if (settings.lecturerMode) {
      if ((cohort || "Guest") === "Guest") return "Guest";
      if (nameMode === "FIRST_INITIAL") return `${first.charAt(0)}. ${last}`;
      if (nameMode === "FIRST_LAST_INITIAL") return `${first} ${last.charAt(0)}.`;
    }
    return `${first} ${last}`;
  }

  function setPodium(rank, s) {
    const id = rank === 1 ? "p1" : rank === 2 ? "p2" : "p3";
    if (!s) {
      P[`${id}_driver`].textContent = "‚Äî";
      P[`${id}_time`].textContent = "‚Äî";
      P[`${id}_detail`].textContent = "‚Äî";
      P[`${id}_meta`].textContent = "‚Äî";
      return;
    }
    const displayName = normalizeName(s.first, s.last, s.cohort);
    P[`${id}_driver`].textContent = displayName;
    P[`${id}_time`].textContent = s.time || "‚Äî";
    P[`${id}_detail`].textContent = `${s.game} ‚Ä¢ ${s.track} ‚Ä¢ ${s.car || "‚Äî"}`;
    P[`${id}_meta`].textContent = `${s.cohort || "Guest"} ‚Ä¢ ${s.course || "‚Äî"}`;
  }

  function passesPinnedFilters(s) {
    const eventId = settings.fullscreen?.eventId || "";
    const game = settings.fullscreen?.game || "";
    if (eventId && s.eventId !== eventId) return false;
    if (game && s.game !== game) return false;
    return true;
  }

  // Auto-scroll state
  let autoScrollActive = false;
  let autoScrollTimer = null;
  let lastLapTime = Date.now();

  function startAutoScroll() {
    if (autoScrollActive || !settings.autoScroll) return;
    if (!scrollWrap) return;

    autoScrollActive = true;
    let dir = 1; // 1 down, -1 up

    const stepPx = 2;
    const tickMs = 40;

    const loop = () => {
      if (!autoScrollActive) return;

      // pause after activity
      if (Date.now() - lastLapTime < 15000) {
        scrollWrap.scrollTop = 0;
        autoScrollTimer = setTimeout(loop, 250);
        return;
      }

      const max = scrollWrap.scrollHeight - scrollWrap.clientHeight;
      const cur = scrollWrap.scrollTop;

      if (max <= 5) {
        scrollWrap.scrollTop = 0;
        autoScrollTimer = setTimeout(loop, 600);
        return;
      }

      // bounce at ends with a pause
      if (dir === 1 && cur >= max - 2) {
        dir = -1;
        autoScrollTimer = setTimeout(loop, settings.autoScrollPauseMs || 2000);
        return;
      }
      if (dir === -1 && cur <= 2) {
        dir = 1;
        autoScrollTimer = setTimeout(loop, settings.autoScrollPauseMs || 2000);
        return;
      }

      scrollWrap.scrollTop = cur + (dir * stepPx);
      autoScrollTimer = setTimeout(loop, tickMs);
    };

    autoScrollTimer && clearTimeout(autoScrollTimer);
    autoScrollTimer = setTimeout(loop, 500);
  }

  function stopAutoScroll() {
    autoScrollActive = false;
    if (autoScrollTimer) {
      clearTimeout(autoScrollTimer);
      autoScrollTimer = null;
    }
    if (scrollWrap) scrollWrap.scrollTop = 0;
  }

  // Spotlight state
  let spotlightActive = false;
  let spotlightTimer = null;
  let currentSpotlight = null;

  function startSpotlight() {
    if (spotlightActive || !settings.spotlight) return;
    spotlightActive = true;

    const loop = () => {
      if (!spotlightActive) return;

      let list = scores.filter(passesPinnedFilters);
      list.sort((a, b) => timeToMs(a.time) - timeToMs(b.time));

      if (!list.length) {
        currentSpotlight = null;
        render();
        spotlightTimer = setTimeout(loop, settings.spotlightRateMs || 10000);
        return;
      }

      if (settings.spotlightMode === "recent") {
        currentSpotlight = list[0];
      } else if (settings.spotlightMode === "random") {
        const top20 = list.slice(0, Math.min(20, list.length));
        currentSpotlight = top20[Math.floor(Math.random() * top20.length)];
      } else if (settings.spotlightMode === "improved") {
        currentSpotlight = list[Math.floor(Math.random() * Math.min(5, list.length))];
      } else {
        currentSpotlight = list[0];
      }

      render();
      spotlightTimer = setTimeout(loop, settings.spotlightRateMs || 10000);
    };

    spotlightTimer && clearTimeout(spotlightTimer);
    spotlightTimer = setTimeout(loop, settings.spotlightRateMs || 10000);
  }

  function stopSpotlight() {
    spotlightActive = false;
    currentSpotlight = null;
    if (spotlightTimer) {
      clearTimeout(spotlightTimer);
      spotlightTimer = null;
    }
    render();
  }

  function render() {
    cleanupPulse();

    const track = String(settings.defaultTrack || "").toLowerCase();
    eventNameEl.textContent = settings.defaultTrack || "‚Äî";

    let list = scores;
    if (track) list = list.filter(s => String(s.track || "").toLowerCase() === track);

    list.sort((a,b) => timeToMs(a.time) - timeToMs(b.time));

    setPodium(1, list[0]);
    setPodium(2, list[1]);
    setPodium(3, list[2]);

    const view = list.slice(0, 20);

    rows.innerHTML = view.map((s, i) => {
      const pulse = pulseIds.has(s.id) ? "pulse-new" : "";
      const tag = `${escapeHtml(s.cohort || "Guest")} ‚Ä¢ ${escapeHtml(s.course || "‚Äî")}`;
      const isSpotlight = currentSpotlight && s.id === currentSpotlight.id;

      const spotlightClass = isSpotlight
        ? " ring-4 ring-amber-500/70 bg-amber-500/10"
        : (spotlightActive && currentSpotlight ? " opacity-40" : "");

      const zebra = (i % 2 === 0) ? " bg-zinc-950/10" : "";
      const displayName = normalizeName(s.first, s.last, s.cohort);

      return `
        <tr class="${pulse}${spotlightClass}${zebra} hover:bg-zinc-950/25 transition">
          <td class="px-[var(--pad)] py-[var(--rowPadY)] text-zinc-300 font-semibold t-rank">${rank}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] text-white font-semibold truncate">${escapeHtml(displayName)}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] text-amber-300 font-semibold">${escapeHtml(getRatingDisplay(s))}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] text-white font-extrabold tracking-tight t-time tabular">${escapeHtml(s.time)}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] text-zinc-200 hidden md:table-cell">${escapeHtml(s.game)}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] text-zinc-100 truncate">${escapeHtml(s.track)}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] text-zinc-300 hidden lg:table-cell truncate">${escapeHtml(s.car || "‚Äî")}</td>
          <td class="px-[var(--pad)] py-[var(--rowPadY)] text-zinc-300 hidden xl:table-cell">${tag}</td>
        </tr>
      `;
    }).join("");

    count.textContent = `${list.length} entries`;
  }

  socket.on("loadScores", (existing) => {
    scores = Array.isArray(existing) ? existing : [];
    render();
  });

  socket.on("settingsUpdate", (s) => {
    settings = s || settings;
    liveLabel.textContent = "Live";
    liveDot.className = "w-2.5 h-2.5 rounded-md bg-red-500";
    render();
  });

  socket.on("ratingsUpdate", (r) => {
    ratings = r || {};
    render();
  });

  socket.on("settingsUpdate", (s) => {
    settings = s || settings;

    // auto-scroll
    if (settings.autoScroll) startAutoScroll();
    else stopAutoScroll();

    // spotlight
    if (settings.spotlight) startSpotlight();
    else stopSpotlight();

    render();
  });

  socket.on("scoreUpdate", (row) => {
    scores.push(row);
    pulseIds.set(row.id, Date.now() + 1400);
    render();
  });

  socket.on("scoreReplace", (row) => {
    const idx = scores.findIndex(s => s.id === row.id);
    if (idx !== -1) scores[idx] = row; else scores.push(row);
    pulseIds.set(row.id, Date.now() + 1400);
    render();
  });

  socket.on("deleteScore", ({ id }) => {
    scores = scores.filter(s => s.id !== id);
    render();
  });

  socket.on("clearAll", () => { scores = []; render(); });

  socket.on("disconnect", () => {
    liveLabel.textContent = "Disconnected";
    liveDot.classList.remove("bg-emerald-500");
    liveDot.classList.add("bg-red-500");
  });

  socket.on("connect", () => {
    liveLabel.textContent = "Live";
    liveDot.classList.remove("bg-red-500");
    liveDot.classList.add("bg-emerald-500");
  });
</script>
</body>
</html>
