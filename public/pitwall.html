<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pit Wall Telemetry</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="min-h-screen bg-black text-white">
  <div class="max-w-[1700px] mx-auto px-6 py-8">
    <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
      <div>
        <p class="text-xs uppercase tracking-[0.35em] text-red-500">Racing Leaderboard</p>
        <h1 class="text-3xl md:text-4xl font-black tracking-tight">Pit Wall Telemetry</h1>
        <p class="text-white/60">Live performance graphs and driver vitals (telemetry required).</p>
      </div>
      <nav class="flex items-center gap-2 text-sm">
        <a href="/" class="px-4 py-2 rounded-md border border-white/20 bg-red-500/10 hover:bg-red-500/15">Display</a>
        <a href="/map" class="px-4 py-2 rounded-md border border-white/20 bg-red-500/10 hover:bg-red-500/15">Track Map</a>
      </nav>
    </header>

    <div class="grid grid-cols-12 gap-6">
      <section class="col-span-12 lg:col-span-8 space-y-6">
        <div class="rounded-md border border-white/10 bg-black/90 p-5 shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="text-lg font-semibold">Speed / Throttle / Brake</h2>
              <p id="trackLabel" class="text-xs text-white/60">Track: Spa-Francorchamps</p>
            </div>
            <span id="telemetryStatus" class="text-xs text-white/60">Waiting for telemetry…</span>
          </div>
          <div class="space-y-4">
            <div>
              <div class="flex items-center justify-between text-xs text-white/60">
                <span>Speed</span>
                <span id="speedLabel">— km/h</span>
              </div>
              <div class="h-3 rounded-md bg-white/10">
                <div id="speedBar" class="h-3 rounded-md bg-red-500" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex items-center justify-between text-xs text-white/60">
                <span>Throttle</span>
                <span id="throttleLabel">— %</span>
              </div>
              <div class="h-3 rounded-md bg-white/10">
                <div id="throttleBar" class="h-3 rounded-md bg-red-400" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex items-center justify-between text-xs text-white/60">
                <span>Brake</span>
                <span id="brakeLabel">— %</span>
              </div>
              <div class="h-3 rounded-md bg-white/10">
                <div id="brakeBar" class="h-3 rounded-md bg-white" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="rounded-md border border-white/10 bg-black/90 p-5 shadow-lg">
          <div class="flex items-center justify-between text-xs text-white/60">
            <span>Telemetry history (last ~60s)</span>
            <span id="deltaLabel">—</span>
          </div>
          <div class="mt-3 rounded-lg border border-white/10 bg-black p-2">
            <canvas id="telemetryChart" class="w-full h-28"></canvas>
          </div>
        </div>
      </section>

      <aside class="col-span-12 lg:col-span-4 space-y-6">
        <div class="rounded-md border border-white/10 bg-black/90 p-5 shadow-lg">
          <h2 class="text-lg font-semibold">Driver</h2>
          <div class="mt-4 space-y-3 text-sm text-white/60">
            <div class="flex items-center justify-between">
              <span>Name</span>
              <span id="driverLabel" class="text-white">—</span>
            </div>
            <div class="flex items-center justify-between">
              <span>Car</span>
              <span id="carLabel" class="text-white">—</span>
            </div>
            <div class="flex items-center justify-between">
              <span>Lap</span>
              <span id="lapLabel" class="text-white">—</span>
            </div>
            <div class="flex items-center justify-between">
              <span>Last lap</span>
              <span id="lastLapLabel" class="text-white">—</span>
            </div>
          </div>
        </div>

        <div class="rounded-md border border-white/10 bg-black/90 p-5 shadow-lg">
          <h2 class="text-lg font-semibold">Systems</h2>
          <div class="mt-4 space-y-3 text-sm text-white/60">
            <div class="flex items-center justify-between">
              <span>Fuel</span>
              <span id="fuelLabel" class="text-white">—</span>
            </div>
            <div class="flex items-center justify-between">
              <span>Tires</span>
              <span id="tireLabel" class="text-white">—</span>
            </div>
            <div class="flex items-center justify-between">
              <span>ERS</span>
              <span id="ersLabel" class="text-white">—</span>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
  const socket = io();

  const telemetryStatus = document.getElementById("telemetryStatus");
  const trackLabel = document.getElementById("trackLabel");
  const speedBar = document.getElementById("speedBar");
  const throttleBar = document.getElementById("throttleBar");
  const brakeBar = document.getElementById("brakeBar");
  const speedLabel = document.getElementById("speedLabel");
  const throttleLabel = document.getElementById("throttleLabel");
  const brakeLabel = document.getElementById("brakeLabel");
  const deltaLabel = document.getElementById("deltaLabel");
  const telemetryChart = document.getElementById("telemetryChart");
  const chartCtx = telemetryChart.getContext("2d");
  const driverLabel = document.getElementById("driverLabel");
  const carLabel = document.getElementById("carLabel");
  const lapLabel = document.getElementById("lapLabel");
  const lastLapLabel = document.getElementById("lastLapLabel");
  const fuelLabel = document.getElementById("fuelLabel");
  const tireLabel = document.getElementById("tireLabel");
  const ersLabel = document.getElementById("ersLabel");
  let defaultTrack = "spa";
  const history = [];
  const maxSamples = 120;

  function resizeChart() {
    const ratio = window.devicePixelRatio || 1;
    const width = telemetryChart.clientWidth || 600;
    const height = telemetryChart.clientHeight || 112;
    telemetryChart.width = Math.floor(width * ratio);
    telemetryChart.height = Math.floor(height * ratio);
    chartCtx.setTransform(ratio, 0, 0, ratio, 0, 0);
  }

  function drawChart() {
    const width = telemetryChart.clientWidth || 600;
    const height = telemetryChart.clientHeight || 112;
    chartCtx.clearRect(0, 0, width, height);

    chartCtx.strokeStyle = "rgba(255,255,255,0.1)";
    chartCtx.beginPath();
    chartCtx.moveTo(0, height / 2);
    chartCtx.lineTo(width, height / 2);
    chartCtx.stroke();

    const drawLine = (key, color, max) => {
      chartCtx.strokeStyle = color;
      chartCtx.beginPath();
      history.forEach((point, idx) => {
        const x = (idx / (maxSamples - 1)) * width;
        const value = Math.min(1, Math.max(0, (point[key] || 0) / max));
        const y = height - value * height;
        if (idx === 0) chartCtx.moveTo(x, y);
        else chartCtx.lineTo(x, y);
      });
      chartCtx.stroke();
    };

    drawLine("speed", "#ef4444", 350);
    drawLine("throttle", "#ffffff", 100);
    drawLine("brake", "rgba(255,255,255,0.5)", 100);
  }

  async function loadDefaultTrack() {
    try {
      const res = await fetch("/api/settings");
      const data = await res.json();
      defaultTrack = data.defaultTrack || defaultTrack;
      trackLabel.textContent = `Track: ${defaultTrack}`;
    } catch {
      trackLabel.textContent = `Track: ${defaultTrack}`;
    }
  }

  resizeChart();
  loadDefaultTrack();
  window.addEventListener("resize", () => {
    resizeChart();
    drawChart();
  });

  function setBar(el, value, max) {
    const pct = max > 0 ? Math.max(0, Math.min(1, value / max)) : 0;
    el.style.width = `${(pct * 100).toFixed(0)}%`;
  }

  socket.on("telemetryUpdate", (payload) => {
    telemetryStatus.textContent = "Live telemetry connected";
    if (!payload) return;

    speedLabel.textContent = `${payload.speed ?? "—"} km/h`;
    throttleLabel.textContent = `${payload.throttle ?? "—"} %`;
    brakeLabel.textContent = `${payload.brake ?? "—"} %`;

    setBar(speedBar, payload.speed || 0, 350);
    setBar(throttleBar, payload.throttle || 0, 100);
    setBar(brakeBar, payload.brake || 0, 100);

    deltaLabel.textContent = payload.delta || "—";
    if (payload.track) trackLabel.textContent = `Track: ${payload.track}`;
    driverLabel.textContent = payload.driver || "—";
    carLabel.textContent = payload.car || "—";
    lapLabel.textContent = payload.lap ?? "—";
    lastLapLabel.textContent = payload.lastLap || "—";
    fuelLabel.textContent = payload.fuel || "—";
    tireLabel.textContent = payload.tires || "—";
    ersLabel.textContent = payload.ers || "—";

    history.push({ speed: payload.speed || 0, throttle: payload.throttle || 0, brake: payload.brake || 0 });
    if (history.length > maxSamples) history.shift();
    drawChart();
  });

  socket.on("settingsUpdate", (s) => {
    defaultTrack = s?.defaultTrack || defaultTrack;
    trackLabel.textContent = `Track: ${defaultTrack}`;
  });
</script>
</body>
</html>
